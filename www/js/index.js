/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

t_not_connected_text = ['Make sure that your Wi-Fi or cellular mobile data is turned on and then try again.', 'Upewnij się, że Wifi lub dane komórkowe są włączone, a następnie spróbuj ponownie.', 'Asegúrate que el WiFi o datos móviles están activados e inténtalo otra vez.', 'Vergewissere dich, dass dein WLAN oder Mobilfunknetz eingeschaltet ist und versuche es dann nochmal.', 'Assurez-vous que le Wi-Fi ou les données mobiles sont activées et essayez de nouveau.'];
t_not_connected_title = ['No internet connection', 'Nie można połączyć się z internetem', 'No hay conexión a internet', 'Keine Internetverbindung', 'Pas de connexion Internet'];
t_not_connected_exit = ['OK', 'OK', 'OK', 'OK', 'OK'];
t_during_learning = ['Lesson in progress', 'W trakcie nauki', 'En progreso', 'Lektion im Gange', 'Leçon en cours'];
t_lesson_skipped = ['Skipped', 'Pominięta', 'Omitida', 'Übersprungen', 'Leçon sautée'];
t_learned_lesson = ['Completed', 'Ukończona', 'Finalizada', 'Abgeschlossen', 'Terminée'];
t_recognize_error_title = ["Didn't catch that", 'Niepoprawna odpowiedź', 'No lo entendemos', 'Das habe ich nicht verstanden', "Nous n'avons pas compris"];
t_recognize_error_try_again = ['Try again', 'Spróbuj ponownie', 'Inténtalo de nuevo', 'Versuche es nochmal', 'Essayez de nouveau'];
t_recognize_error_skip = ['Skip the task', 'Pomiń zadanie', 'Omitir tarea', 'Aufgabe überspringen', "Passez l'exercice"];
t_recognize_error_first_text = ['Try to speak more clearly and loudly.', 'Staraj się mówić głośno i wyraźnie.', 'Trata de hablar más alto y claro.', 'Versuche, deutlicher und lauter zu sprechen.', 'Essayez de parler plus clairement et plus fort.'];
t_recognize_error_second_text = ["Please try to say the phrase in exactly the same way as you heard it. This applies to vocabulary and contractions.", 'Postaraj się wymówić wyrażenie w taki sam sposób w jaki je usłyszałeś (dotyczy to zarówno słownictwa jak i skrótów).', 'Trata de decir la frase exactamente de la misma forma que la has oído (haz lo mismo tanto con el vocabulario como con las contracciones).', 'Bitte wiederhole den Satz genauso, wie du ihn gehört hast. Das gilt auch für Vokabeln und Kontraktionen.', "Essayez de dire la phrase dans le même ordre que vous l'avez entendu (cela s'applique au vocabulaire et aux contractions)."];
t_recognize_error_third_text = ["Remember sometimes speech recognition is not accurate.", 'Pamiętaj, że rozpoznawanie mowy nie zawsze jest bezbłędne.', 'Recuerda que a veces el reconocimiento de voz no es preciso.', 'Denke daran, das die Spracherkennung manchmal nicht exakt ist.', "Souvenez- vous que parfois, le système de reconnaissance vocal n'est pas précis. Essayez à nouveau ou passez la tâche."];
t_end_new_materials_title = ["Congratulations!", "Gratulacje!", "¡Enhorabuena!", "Herzlichen Glückwunsch!", "Félicitations!"];
t_end_new_materials_text = ["You went through all the content. Now repeat the lessons to become a Pro.", "Ukończyłeś naukę wszystkich wyrażeń. Od następnej lekcji będziesz jedynie utrwalał materiał.", "Ya has completado todo el contenido. Ahora, repite las lecciones para convertirte en un profesional.", "Du hast den gesamten Inhalt erarbeitet. Wiederhole jetzt die Lektionen, um ein Profi zu werden.", "Vous avez parcouru tout le contenu. Maintenant, répétez les leçons pour devenir un pro."];
t_end_new_materials_ok = ["OK", "OK", "OK", "OK", "OK"];
t_liked_words_added = ["Phrase has been added to Favourites.", "Fraza została dodana do zakładki ulubione.", "Frase añadida a Favoritos.", "Der Satz wurde zu deinen Favoriten hinzugefügt.", "La phrase a été ajoutée à vos favoris."];
t_liked_words_remove = ["The phrase has been deleted from favourites", "Zwrot został usunięty z zakładki ''Ulubione''", "Frase eliminada de Favoritos", "Die Phrase wurde aus den Favoriten gelöscht", "La phrase a été effacée des favoris"];
t_no_audio_lesson_title = ["Audio not available.", "Nagrania audio niedostępne.", "Audio no disponible.", "Audio nicht verfügbar.", "L'audio n'est pas disponible."];
t_no_audio_lesson_text = ["This free version comes with 30 audio lessons. If you would like to get audio to all 180 lessons, upgrade to English Premium.", "Spośród 180 dostępnych lekcji, 30 zawiera nagrania audio. Wykup dostęp Premium, a otrzymasz nagrania do wszystkich lekcji.", "Inglés 1500+ viene con 180 lecciones de las cuales 30 contienen audio. Si deseas recibir todas las grabaciones de las 180 lecciones, comprar versión premium.", "Englisch 1500+ beinhaltet insgesamt 180 Lektionen ,von denen nur 30 eine Audioaufnahme enthalten. Falls du alle 180 Audioaufnahmen erhalten möchtest, kauf bitte Premiumversion.", "Sur les 180 leçons disponibles, 30 contiennent des enregistrements audio. Achetez version premium et vous obtiendrez les enregistrements audio pour toutes les leçons."];
t_no_audio_lesson_learn_anyway = ["Learn anyway", "Ucz się bez nagrań", "Aprender sin grabaciones", "Trotzdem lernen", "Apprenez sans audio"];
t_no_audio_lesson_upgrade = ["Upgrade", "Wykup dostęp Premium", "Comprar versión premium", "Premiumversion kaufen", "Achetez version premium"];
t_no_audio_lesson_skip = ["Skip lesson", "Pomiń lekcję", "Omitir lección", "Lektion überspringen", "Passez la leçon"];
t_confirm_back_in_learn_title = ["Are you sure?", "Czy jesteś pewien?", "¿Estás seguro(a)?", "Bist du sicher?", "Etes-vous sûr?"];
t_confirm_back_in_learn_text = ["Your progress won't be saved.", "Twój postęp nie zostanie zapisany.", "Tu progreso no será guardado.", "Deine Fortschritte werden nicht gespeichert.", "Votre progrès ne sera pas sauvegardé."];
t_confirm_back_in_learn_back = ["Go back", "Wyjdź", "Volver", "Zurück", "Revenir en arrière"];
t_confirm_back_in_learn_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_confirm_learn_missing_cat_title = ["Are you sure?", "Czy jesteś pewien?", "¿Estás seguro(a)?", "Bist du sicher?", "Etes-vous sûr?"];
t_confirm_learn_missing_cat_text = ["Do you want to learn previously skipped lesson?", "Lekcja została już pominięta", "¿Quereis aprender la lección anterior?", "Die Lektion wurde früher übersprungen.", "Voulez-vous apprendre une leçon que vous avez passée?"];
t_confirm_learn_missing_cat_yes = ["Learn anyway", "Ucz się", "Aprender", "Lernen", "Apprendre"];
t_confirm_learn_missing_cat_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_confirm_learn_inprogress_cat_title = ["Are you sure?", "Czy jesteś pewien?", "¿Estás seguro(a)?", "Bist du sicher?", "Etes-vous sûr?"];
t_confirm_learn_inprogress_cat_text = ["You are learning this lesson already.", "Uczyłeś się już tej lekcji.", "Has aprendido está lección.", "Du hast diese Lektion gelernt.", "Vous avez déjà appris cette leçon."];
t_confirm_learn_inprogress_cat_yes = ["Learn anyway", "Ucz się mimo to", "Aprender", "Lernen", "Apprendre"];
t_confirm_learn_inprogress_cat_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_confirm_skip_lesson_title = ["Are you sure?", "Czy jesteś pewien?", "¿Estás seguro(a)?", "Bist du sicher?", "Etes-vous sûr?"];
t_confirm_skip_lesson_text = ["Repetition is crucial for your long-term memory.", "Powtarzanie jest kluczowe w procesie zapamiętywania.", "La repetición tiene una importancia fundamental para la memorización a largo plazo.", "Wiederholungen sind für das Langzeitgedächtnis sehr wichtig.", "Répéter est essentiel pour la mémoire à long terme."];
t_confirm_skip_lesson_skip = ["Skip", "Pomiń", "Omitir", "Überspringen", "Passez"];
t_confirm_skip_lesson_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_confirm_exit_title = ["Are you sure?", "Czy jesteś pewien?", "¿Estás seguro(a)?", "Bist du sicher?", "Etes-vous sûr?"];
t_confirm_exit_text = ["Please complete the lesson before exiting. Otherwise, your progress won't be saved.", "Ukończ lekcję przed zamknięciem aplikacji.W przeciwnym wypadku postęp nie zostanie zapisany.", "Por favor, completa la lección antes de salir. De lo contrario, tu progreso no será guardado.", "Beende die Lektion, bevor du die Anwendung schließt. Sonst werden deine Fortschritte nicht gespeichert.", "Terminez la leçon avant de fermer l'application. Autrement votre progrès ne sera pas sauvegardé."];
t_confirm_exit_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_confirm_exit_exit = ["Exit", "Wyjście", "Salir", "Beenden", "Quitter"];
t_placeholder_fuzzy_search = ["Search for lesson…", "Szukaj lekcji…", "Buscar lección….", "Lektion … suchen", "Chercher la leçon..."];
t_placeholder_hint_text = ["Click here to write your hint", "Kliknij tutaj napisać własną podpowiedź", "Presiona aquí para escribir tus indicaciones", "Klick hier, um deinen Hinweis zu schreiben", "Cliquez ici pour écrire vos indices"];
t_lang_rank = ["en", "pl", "es", "de", "fr"];
t_after_premium_copy_text = ["You can now safely uninstall the previous version of the application.", "Możesz teraz bepiecznie odinstalować poprzednią wersję aplikacji.", "Tu progreso ha sido cargado exitosamente.", "Du kannst jetzt die vorherige Version der App sicher deinstallieren.", "Vous pouvez maintenant désinstaller en toute sécurité la précédente version de l'application."];
t_after_premium_copy_title = ["Your progress was successfully loaded", "Postęp został poprawnie wczytany", "Tu progreso ha sido cargado exitosamente", "Daten wurden erfolgreich geladen", "Vos progrès ont été téléchargés avec succès"];
t_after_premium_copy_ok = ["OK", "OK", "OK", "OK", "OK"];
t_confirm_remove_saved_word_text = ["The phrase has been deleted from favourites", "Czy chcesz usunąć zwrot z zakładki \"ulubione\"?", "¿Desea eliminar la frase de \"Favoritos\"?", "Möchten Sie die Phrase aus \"Favoriten\" löschen?", "Voulez-vous supprimer la phrase des favoris?"];
t_confirm_remove_saved_word_title = ["Are you sure?", "Czy jesteś pewien?", "¿Estás seguro(a)?", "Bist du sicher?", "Etes-vous sûr?"];
t_confirm_remove_saved_word_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_confirm_remove_saved_word_remove = ["OK", "OK", "OK", "OK", "OK"];
t_import_from_file_error = ["This file is invalid!", "Plik jest nieprawidłowy!", "El archivo es inválido!", "Diese Datei ist ungültig!", "Ce fichier est invalide!"];
t_import_from_file_success = ["Data loaded successfully.", "Postęp został poprawnie wczytany", "Tu progreso ha sido cargado exitosamente.", "Daten wurden erfolgreich geladen.", "Les données ont été téléchargées avec succès."];
t_automated_skipped_lessons = ["lessons were skipped", "lekcji zostało pominiętych", "lecciones han sido saltadas", "Lektionen wurden übersprungen", "leçons ont été sautées"];
t_skipped_lesson_success = ["Lesson has been skipped", "Lekcja została pominięta", "La lección ha sido saltada", "Lektion wurde übersprungen", "Une leçon a été sautée"];
t_app_name = ["English 1500+", "Angielski 1500+", "Inglés 1500+", "Englisch 1500+", "Anglais 1500+"];
t_app_name_pro = ["English 1500+ Pro", "Angielski 1500+ Pro", "Inglés 1500+ Pro", "Englisch 1500+ Pro", "Anglais 1500+ Pro"];
t_thanks_for_buying_text = ["The premium version is active.", "Wersja premium jest aktywna.", "La versión premium está activa.", "Die Premiumversion ist aktiv.", "La version premium est active."];
t_thanks_for_buying_title = ["Congratulations!", "Gratulacje!", "¡Enhorabuena!", "Herzlichen Glückwunsch!", "Félicitations!"];
t_thanks_for_buying_ok = ["OK", "OK", "OK", "OK", "OK"];
t_before_buy_premium_text = ["Buy premium version.", "Wykup dostęp Premium, a otrzymasz:\n- nagrania audio do wszystkich lekcji\n- wersję bez reklam", "Compra la versión premium y recibirás:\n- Los audios de las 180 lecciones\n- Contenido sin publicidad", "Kauf dir die Premiumversion, dann erhältst du:\n- Audios für alle 180 Lektionen\n- werbefreie Inhalte", "Achetez la version premium pour obtenir:\n- les audios pour toutes les leçons\n- une version sans publicités"];
t_before_buy_premium_title = ["The premium version", "Wersja premium", "La versión premium", "Die Premiumversion", "La version premium"];
t_before_buy_premium_cancel = ["Cancel", "Anuluj", "Cancelar", "Abbrechen", "Annulez"];
t_before_buy_premium_buy = ["Buy premium version", "Wykup dostęp Premium", "Comprar versión premium", "Premiumversion kaufen", "Achetez version premium"];

/*translacje*/
function getTrans(key) {
    if (langJSON.lang > 0) {
        return key[parseInt(langJSON.lang - 1)];
    } else {
        return key[0];
    }
}

// PREMIUM CHANGE
var isPremium = false;
var dev = true;
var isLegal = false;
var legalValidation = true;
var isPayedPro = false;

var app = {
    // Application Constructor
    initialize: function () {
        this.bindEvents();
    },
    // Bind Event Listeners
    //
    // Bind any events that are required on startup. Common events are:
    // 'load', 'deviceready', 'offline', and 'online'.
    bindEvents: function () {
        document.addEventListener('deviceready', this.onDeviceReady, false);
    },
    // deviceready Event Handler
    //
    // The scope of 'this' is the event. In order to call the 'receivedEvent'
    // function, we must explicitly call 'app.receivedEvent(...);'

    onDeviceReady: function () {
        var src = '/android_asset/www/date/1.mp3';
        my_media = new Media(src, function () {
        }, function (err) {
            console.log("M: " + err.message + " - " + err.code);
        });

        $('#menu-switch').hide();
        $('#menu').hide();
        $("#first-use-loading-page").show();
        logEventInServer('run application', {});
        getMyLang();

        document.addEventListener("resume", hideBars, false);
        if ($(window).width() > 600) {
            StatusBar.hide();
        } else {
            AndroidFullScreen.immersiveMode(emptyFunctionS, emptyFunctionS);
        }

        document.addEventListener('onAdDismiss', function (data) {
            //prepareAd();
            removeAllProgress();
            removeAllProgress2();
            setTimeout(function () {
                loadProgressBarToFull();
                loadProgressBarToFull2();
            }, 100);
        });

        document.addEventListener('onAdPresent', function (data) {
            setTimeout(function () {
                removeAllProgress();
                removeAllProgress2();
            }, 50);
            prepareAd();
        });

        document.addEventListener('onAdFailLoad', function (e) {
            setAdIsReady(false);
        });

        document.addEventListener('onAdLoaded', function (data) {
            setAdIsReady(true);
        });

        document.addEventListener("backbutton", function (e) {
            e.preventDefault();
        }, false);

        setTextWidth();

        volumeTest();

        //smoothLoadProgressBarWelcome();

        if(!isPremium) {
            initStore();
        }
    },
    // Update DOM on a Received Event
    receivedEvent: function (id) {
        var parentElement = document.getElementById(id);
        var listeningElement = parentElement.querySelector('.listening');
        var receivedElement = parentElement.querySelector('.received');

        listeningElement.setAttribute('style', 'display:none;');
        receivedElement.setAttribute('style', 'display:block;');

        console.log('Received Event: ' + id);
    }
};

function emptyFunctionS() {
    console.log("jestem");
}

function hideBars() {
    if (!dev) {
        if ($(window).width() > 600) {
            StatusBar.hide();
        } else {
            AndroidFullScreen.immersiveMode(emptyFunctionS, emptyFunctionS);
        }
    }
}

/* OBSŁUGA ŚCIEŻKI */
var mainPath;

function path() {
    var res = (cordova.file.externalDataDirectory).split('/').slice(-5);
    mainPath = (res.toString()).replace(/,/g, '/');
    return (res.toString()).replace(/,/g, '/');
}

var demoPathsrc;

function demoPath() {
    if (isPremium) {
        var res = (cordova.file.externalDataDirectory).split('/').slice(-5);
        demoPathsrc = (res.toString()).replace(/,/g, '/');
        demoPathsrc = demoPathsrc.substring(0, demoPathsrc.length - 10) + "/files/";
        return demoPathsrc;
    } else {
        demoPathsrc = path();
        return demoPathsrc;
    }
}

var premiumPathsrc;

function premiumPath() {
    if (isPremium) {
        premiumPathsrc = path();
        return premiumPathsrc;
    } else {
        var res = (cordova.file.externalDataDirectory).split('/').slice(-5);
        premiumPathsrc = (res.toString()).replace(/,/g, '/');
        premiumPathsrc = premiumPathsrc.substring(0, premiumPathsrc.length - 7) + "Pro/files/";
        return premiumPathsrc;
    }
}

/* END OBSŁUGA ŚCIEŻKI */

/* READ FILE3 */
function readDayF() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFSSuccess3, onFSError);
}

function onFSSuccess3(fileSystem) {
    fileSystem.root.getFile(srcFile3, {create: false, exclusive: false}, gotFileEntry3, onFSError);
}

function gotFileEntry3(fileEntry) {
    fileEntry.file(gotFile3, onFSError);
}

function gotFile3(file) {
    readAsText3(file);
}

function readAsText3(file) {
    var reader = new FileReader();
    reader.onloadend = function (e) {
        res3 = e.target.result;
    };
    reader.readAsText(file);
}

/* END READ FILE */

/* READ LANG */
function readLang() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFSSuccessLangR, onFSErrorLangR);
}

function onFSSuccessLangR(fileSystem) {
    fileSystem.root.getFile(srcLang, {create: false, exclusive: false}, gotFileEntryLangR, onFSErrorLangR);
    rootURL = fileSystem.root.toURL();
}

function gotFileEntryLangR(fileEntry) {
    fileEntry.file(gotFileLangR, onFSErrorLangR);
}

function gotFileLangR(file) {
    readAsTextLangR(file);
}

function readAsTextLangR(file) {
    var reader = new FileReader();
    reader.onloadend = function (e) {
        afterReadMyLang(e.target.result);
    };
    reader.readAsText(file);
}

function onFSErrorLangR(err) {
    afterReadMyLang('{"lang":-1}');
}

/* END READ FILE */

/* READ FILE */
function readWriteFile() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFSSuccess, onFSError);
}

function onFSSuccess(fileSystem) {
    fileSystem.root.getFile(srcFile, {create: false, exclusive: false}, gotFileEntry, onFSError);
}

function gotFileEntry(fileEntry) {
    fileEntry.file(gotFile, onFSError);
}

function gotFile(file) {
    readAsText(file);
}

function readAsText(file) {
    var reader = new FileReader();
    reader.onloadend = function (e) {
        afterReadToLearn(e.target.result);
    };
    reader.readAsText(file);
}

function onFSError(err) {
    res = "[]";
}

/* END READ FILE */

/* READ FILE2 */
function readWriteFile2() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFSSuccess2, onFSError);
}

function onFSSuccess2(fileSystem) {
    fileSystem.root.getFile(srcFile2, {create: false, exclusive: false}, gotFileEntry2, onFSError);
}

function gotFileEntry2(fileEntry) {
    fileEntry.file(gotFile2, onFSError);
}

function gotFile2(file) {
    readAsText2(file);
}

function readAsText2(file) {
    var reader = new FileReader();
    reader.onloadend = function (e) {
        afterNoticeRead(e.target.result);
    };
    reader.readAsText(file);
}

/* END READ FILE */

/* SAVE FILE */

var srcSaveTmp = false;
var srcSaveOld = false;
var srcSaveDayTmp = false;
var endTodayLesson = false;

function saveFile() {

    //				endLearn();

    srcSaveTmp = path() + "save_tmp.json";
    srcSaveOld = path() + "save_old.json";
    //renameFile(srcSave,'',srcSaveOld, renameSuccessSave);
    saveFileOld();
}

function renameSuccessSave() {
    saveFileOld();
}

function saveFileOld() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSN2, failN);
}

function gotFSN2(fileSystem) {
    fileSystem.root.getFile(srcSaveTmp, {create: true}, gotFileEntryN2, failN);
}

function gotFileEntryN2(fileEntry) {
    fileEntry.createWriter(gotFileWriterN2, failN);
}

function gotFileWriterN2(writer) {

    writer.onwriteend = function (e) {
        renameFile(srcSaveTmp, '', srcSave, renameSuccessSaveEnd);
    };

    writer.write(JSON.stringify(datesJSON));
    writer.abort();
}

function renameSuccessSaveEnd() {
    //zapisz dzień
    saveFile5();
}

function failN(error) {

}

/* END SAVE FILE */

/* SAVE LANG */
function saveMyLang(mylang) {
    langJSON.lang = mylang;
    getCatWithPos(0, 1);
    saveLang();
}

function saveLang() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSNLang, failN);
}

function gotFSNLang(fileSystem) {
    fileSystem.root.getFile(srcLang, {create: true}, gotFileEntryLang, failN);
}

function gotFileEntryLang(fileEntry) {
    fileEntry.createWriter(gotFileWriterLang, failN);
}

function gotFileWriterLang(writer) {
    writer.onwrite = function (evt) {
        console.log("write success");
    };
    writer.write(JSON.stringify(langJSON));
    writer.abort();
}

/* END SAVE FILE */

/* SAVE FILE2 - DAY*/
function saveFile5() {
    srcSave5 = path() + "day.json";
    srcSaveDayTmp = path() + "day_tmp.json";
    saveFileDay();
}

function saveFileDay() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSN5, failN);
}

function gotFSN5(fileSystem) {
    fileSystem.root.getFile(srcSaveDayTmp, {create: true}, gotFileEntryN5, failN);
}

function gotFileEntryN5(fileEntry) {
    fileEntry.createWriter(gotFileWriterN5, failN);
}

function gotFileWriterN5(writer) {
    writer.onwriteend = function (e) {
        renameFile(srcSaveDayTmp, '', srcSave5, renameSuccessSaveDayEnd);
    };

    writer.write(JSON.stringify(datesJSON5));
    writer.abort();
}

function renameSuccessSaveDayEnd() {
    if (endTodayLesson) {
        endLearn();
    }
}

/* END SAVE FILE */

/*POTRZEBNE ZMIENNE*/
var wordsInOneCat = 10;
var minCat = 7;
var countOfCycle = 2;
var countCatInFirstBigCat = 10;
var firstCycle = false;
var secondCycle = false;
var thirdCycle = false;
var srcSave = false;
var srcSave5 = false;
var srcLang = false;
var datesJSON = false;
var datesJSON5 = false;
var dayJSONwordsCopy = 0;
var learnedWordsCopy = 0;

var langJSON = dev ? JSON.parse('{"lang": 2}') : JSON.parse('{"lang":-1}');
var dayJSON = dev ? JSON.parse('{"day": 5, "words": 10, "km": 10, "skiped": ["1/10"], "rating": false, "theme": 1}') : false;
var toLearnJSON = dev ? JSON.parse('[{"subid":13,"catid":1,"start":"3"}]') : [];

var dayJSONwordsCopy = dayJSON.words;
var toLearnJSONcopyForBackBTN = JSON.parse(JSON.stringify(toLearnJSON));
var resLang = false;
var res = false;
var srcFile = false;
var res2 = false;
var srcFile2 = false;
var res3 = false;
var srcFile3 = false;
var noticeJSON = [];
var likedJSON = [];
var isFirstCycle = true;
var startLearn = false;
var toLearn = [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1];
var countWord = 0;
var countCatsToLearn = 0; //without repeatitions
var countCatsToLearnToday = 1; //with repeatitions
var countWordsToLearn = wordsInOneCat + (wordsInOneCat * 2)//wordsInOneCat*2; //2 cykle w nowej kategorii po 10 słów
var learnedWords = 0;
var learnedWordsInCat = 0;
var countWordsToLearnInThisCycle = 0;
var suggestedCatPath = "";
var suggestedCatName = "";
var learnedCat = [];
var inProgressCat = [];
var missingCat = [];
var gameIsBegin = false;
var allCats = [];
var allUsedCats = [];
var allEndedCats = [];
var catsWithAudioInDemo = [];
var todayEndedCat = "";
var rootURL = "";
var lessonsJumpToFuture = 0;
var hasNewCatsToday = false;

/* START APP*/
function startApp() {
    setTextWidth();
    hideBars();
    setTimeout(function () {
        var lang = langJSON.lang;
        prepareAd();
        //TAK
        if (lang < 1) {
            if (!isPremium) {
                $("#first-use-loading-page").hide();
                startLearn = true; //po tutorialu zacznie naukę
                getLangList(); //wybierz swój język
                $("#choose-lang").show(); //zapisz język jest w funciton setLang w index.html
            }
            copyFirstPath();
            updatePlaceholders();
        }
        else {
            //NIE
            $('#menu-switch').show();
            $('#menu').show();
            $("#myLang").val(lang);
            $("body").addClass('lang' + lang);
            getDay(); //pobierz numer dnia
            getNotice(); //pobierz notice
            readLikedWords(); //pobierz liked words
            updatePlaceholders();
        }
    }, 200);
}

/*END START APP*/
function getMyLang() {
    srcLang = path() + "lang.json";
    if (!dev) {
        readLang();
    } else {
        afterReadMyLang(JSON.stringify(langJSON));
    }
}

function afterReadMyLang(langData) {
    langJSON = JSON.parse(langData);
    if(typeof langJSON.lang != 'undefined' && langJSON.lang > 0) {
        $("body").addClass('lang' + langJSON.lang);
        testAndRunAppIfIsOk(startApp);
    } else {
        if (!isPremium) {
            $("#first-use-loading-page").hide();
            startLearn = true; //po tutorialu zacznie naukę
            getLangList(); //wybierz swój język
            $("#choose-lang").show(); //zapisz język jest w funciton setLang w index.html
        }
        copyFirstPath();
        updatePlaceholders();
    }
}

function testAndRunAppIfIsOk(callbackAfterValid) {
    if(!dev) {
        if (!checkConnection()) {
            navigator.notification.confirm(
                getTrans(t_not_connected_text),
                onNoInternetConfirm,
                getTrans(t_not_connected_title),
                getTrans(t_not_connected_exit)
            );
        } else {
            testLegalAppAndRunIfIsLegal(callbackAfterValid);
        }
    } else {
        startAppBecauseIsLegal(callbackAfterValid);
    }
}

function getDay() {
    srcFile3 = path() + "day.json";
    if (!dev) {
        readDayF();
        getDayHelper();
    } else {
        getAllCatsInArray();
        getAllCatsToShowAllCats();
        afterGetDay();
    }
}

function getDayHelper() {
    if (res3 == false) {
        setTimeout(getDayHelper, 100);
        return;
    } else {
        getAllCatsInArray();
        getAllCatsToShowAllCats();

        dayJSON = JSON.parse(res3);
        dayJSONwordsCopy = dayJSON.words;
        afterGetDay();
    }
}

function afterGetDay() {
    logEventInServer('start day', {day: dayJSON.day, lang: langJSON.lang});
    countWordsToLearn = wordsInOneCat + (wordsInOneCat * 2);
    countOfCycle = 2;
    countCatsToLearn = 0;
    countCatsToLearnToday = 1;
    inProgressCat = [];
    $("#nrDayFiled").text(dayJSON.day);
    $(".allWords").text(dayJSON.words);
    $("#end-nr-lesson").text(dayJSON.day);
    $("#countWordsToLearn").text(dayJSON.day - 1);
    $(".equivalentLessons").text(dayJSON.day - 1); //usunąć
    $(".all-words-to-end").text(countWordsToLearn);
    $(".all-words-to-end-sesion").text(countWordsToLearnInThisCycle);
    $(".countKMLearned").text(Math.floor(dayJSON.km * minCat / 60)); //usunąć
    $(".countMinLearned").text(dayJSON.km * minCat % 60); //usunąć
    for (var x in dayJSON.skiped) {
        var skip = dayJSON.skiped[x];
        allUsedCats.push(skip);
        allEndedCats.push(skip);
    }
    $("body").addClass('theme' + dayJSON.theme);

    getToLearn();
}

function getNotice() {
    srcFile2 = path() + "notice.json";
    if (!dev) {
        readWriteFile2();
    }
}

function afterNoticeRead(resNotice) {
    noticeJSON = JSON.parse(resNotice);
}

function getToLearn() {
    srcFile = path() + "save.json";
    if (!dev) {
        readWriteFile();
    } else {
        afterReadToLearn(JSON.stringify(toLearnJSON));
    }
}

function afterReadToLearn(tolearnfromFile) {
    toLearnJSON = JSON.parse(tolearnfromFile);
    toLearnJSONcopyForBackBTN = JSON.parse(JSON.stringify(toLearnJSON));

    if (toLearnJSON.length == 0) {
        getCatWithPos(0, 1);
        startLessonAfterSetUpEverything();
    }
    for (var x in toLearnJSON) {
        var pack = toLearnJSON[x];
        var day = dayJSON.day;
        var dayNr = day - pack.start;
        allUsedCats.push(pack.catid + "/" + pack.subid);
        if (dayNr >= 27) {
            learnedCat.push(pack.catid + "/" + pack.subid);
            allEndedCats.push(pack.catid + "/" + pack.subid);
        }
        if (dayNr < 27) {
            inProgressCat.push(pack.catid + "/" + pack.subid);
            inProgressCatcopyForBackBTN = inProgressCat.slice();
        }
        switch (dayNr) {
            case 1:
                /*
			toLearn[0] = pack.catid + "/" + pack.subid;
			toLearn[1] = pack.catid + "/" + pack.subid;
			countCatsToLearn++;
			countOfCycle++;
			countOfCycle++;
			countWordsToLearn += wordsInOneCat;
			countWordsToLearn += wordsInOneCat*2;
			inProgressCat.push(pack.catid + "/" + pack.subid);
		*/
                break;
            case 2:
                toLearn[2] = pack.catid + "/" + pack.subid;
                toLearn[3] = pack.catid + "/" + pack.subid;
                countCatsToLearn++;
                countOfCycle++;
                countOfCycle++;
                countWordsToLearn += wordsInOneCat * 2;
                countWordsToLearn += wordsInOneCat;
                setSuggestedCat(pack.catid, pack.subid);
                inProgressCat.push(pack.catid + "/" + pack.subid);
                break;
            case 10:
                toLearn[4] = pack.catid + "/" + pack.subid;
                toLearn[5] = pack.catid + "/" + pack.subid;
                countCatsToLearn++;
                countOfCycle++;
                countOfCycle++;
                countWordsToLearn += wordsInOneCat * 2;
                countWordsToLearn += wordsInOneCat;
                inProgressCat.push(pack.catid + "/" + pack.subid);
                break;
            case 27:
                toLearn[6] = pack.catid + "/" + pack.subid;
                toLearn[7] = pack.catid + "/" + pack.subid;
                todayEndedCat = pack.catid + "/" + pack.subid;
                countCatsToLearn++;
                countOfCycle++;
                countOfCycle++;
                countWordsToLearn += wordsInOneCat * 2;
                countWordsToLearn += wordsInOneCat;
                inProgressCat.push(pack.catid + "/" + pack.subid);
                break;
            default:
                break;
        }

        if (x == (toLearnJSON.length - 1)) {
            if (!suggestedCatName) {
                getCatWithPos(0, 1);
            }

            setTimeout(showInProgressCat, 200);
            setTimeout(function () {
                uniqueallUsedCats = allUsedCats.filter(function (item, pos) {
                    return allUsedCats.indexOf(item) == pos;
                });
                if (allCats.sort().toString() == uniqueallUsedCats.sort().toString()) {
                    countWordsToLearn -= wordsInOneCat + (wordsInOneCat * 2);
                    countOfCycle -= 2;
                    $("#countWordsToLearn").text(dayJSON.day - 1);
                    $(".equivalentLessons").text(dayJSON.day - 1); //usunąć
                    $(".all-words-to-end").text(countWordsToLearn);
                    $(".all-words-to-end-sesion").text(countWordsToLearnInThisCycle);
                    countCatsToLearnToday += countCatsToLearn - 1;
                    $(".allTimeToday").text(countCatsToLearnToday * minCat);
                    //jeżeli nie ma już nowych kategorii ale są jeszcze powtórki
                    if (countCatsToLearn > 0) {
                        $("#repetition-only-info").show();
                        startLessonAfterSetUpEverything();
                    } else {
                        //sprawdź czy są w trakcie nauki jeszcze jakieś kategorię
                        if (inProgressCat.length > 0) {
                            //przeskocz dzień do przodu
                            dayJSON.day = dayJSON.day + 1;
                            afterGetDay();
                            lessonsJumpToFuture++;
                        } else {
                            //wyświetl, że to już koniec kursu
                            $("#first-use-loading-page").hide();
                            $("#end-course").addClass('next-cat-left');
                            $("#end-course").show();
                            setTimeout(function () {
                                $("#end-course").removeClass('next-cat-left');
                                showRating();
                            }, 100);
                        }
                    }
                } else {
                    $("#countWordsToLearn").text(dayJSON.day - 1);
                    $(".equivalentLessons").text(dayJSON.day - 1); //usunąć
                    $(".all-words-to-end").text(countWordsToLearn);
                    $(".all-words-to-end-sesion").text(countWordsToLearnInThisCycle);
                    countCatsToLearnToday += countCatsToLearn;
                    $(".allTimeToday").text(countCatsToLearnToday * minCat);
                    startLessonAfterSetUpEverything();
                }
            }, 250);
        }
    }
}

function startLessonAfterSetUpEverything() {
    setTimeout(function () {
        gameIsBegin = true;
        $("#first-use-loading-page").hide();
        showStartLessonPage();
    }, 200);
}

function setCountWord() {
    for (var i = 0; i < 8; i++) {
        if (toLearn[i] > 0) {
            countWord += wordsInOneCat;
        }
    }
}

function saveDay() {
    dayJSON.day = dayJSON.day + 1;  //zmienić na 1
    dayJSON.km = dayJSON.km + (countOfCycle / 2);
    datesJSON5 = dayJSON;

    $("#learn-container").addClass('next-cat-right');
    setTimeout(function () {
        $("#learn-container").hide();
        $("#saving-progress-today").show();
        setTimeout(function () {
            $("#saving-progress-today").removeClass('next-cat-left');
            setTimeout(function () {
                datesJSON = toLearnJSON;
                srcSave = path() + "save.json";
                saveFile();
            }, 1500);
        }, 100);
    }, 500);
}

function getLangList() {
    $.get("date/lang.json", function (result) {
        showLangList(result);
    });
}

function showLangList(l) {
    var langs = JSON.parse(l);
    for (var x in langs) {
        var lang = langs[x];
        var tmp = '<h1 class="text" ontouchstart="setLang(this);" data-mylang="' + lang.id + '" >' + lang.label + '</h1>';
        if (x > 0) $("#langs").append(tmp);
    }
}

/* END GET LAND LIST */

/* GET CAT LIST */
var subcats = false;

function getCatList() {
    var idCat = $("#myLang").val();
    $.get("date/" + idCat + "/cat.json", function (result) {
        setTimeout(
            function () {
                setTimeout(
                    function () {
                        showCatList(result);
                    }, 200);
                //getToLearn();
            }, 200);
    });
}

function showCatList(c) {
    var cats = JSON.parse(c);
    $("#cats").html("");
    var tmp = '';
    for (var x in cats) {
        subcats = false;
        var cat = cats[x];
        //if(x == 0) tmp += '<div><h1 class="text superbigcat" onclick="expand(this);"><span class="l2">E_Fiszki</span><span class="l3">F_Fiszki</span><span class="l4">N_Fiszki</span><span class="l5">Phrases</span></h1><div>';
        //if(x == countCatInFirstBigCat) tmp += '</div></div><div><h1 class="text superbigcat" onclick="expand(this);"><span class="l2">E_Gramatyka</span><span class="l3">F_Gramatyka</span><span class="l4">N_Gramatyka</span><span class="l5">Gramatyka</span></h1><div>';
        tmp += '<div><h1 class="text supercat" onclick="expand(this);">' + cat.name + '</h1>';
        var extraEnd = parseInt(x) + 1 == parseInt(cats.length) ? '</div></div>' : "";
        tmp += getSubCatList(cat.id) + '</div>';
    }
    $("#cats").append(tmp);
}

function getSubCatName(cs) {
    var res = cs.split("/");
    var idp = res[0];
    var idc = res[1];
    var idLang = $("#myLang").val();
    $.get("date/" + idLang + "/" + idp + "/subcat.json", function (result) {
        var scat = JSON.parse(result);
        for (var x in scat) {
            var cat = scat[x];
            if (cat.id == idc) {
                nameCat = cat.name;
            }
        }
    });
}

function getWordToSuggestCat(cs) {
    var res = cs.split("/");
    var idp = res[0];
    var idc = res[1];
    var idLang = $("#myLang").val();
    $.get("date/" + idLang + "/" + idp + "/" + idc + "/words.json", function (result) {
        $.get("date/1/" + idp + "/" + idc + "/words.json", function (transResult) {
            $("#list-word-in-sug-cat").html("");
            var words = JSON.parse(result);
            var trans = JSON.parse(transResult);
            var i = 0;
            for (var x in words) {
                i++;
                var w = words[x];
                var t = trans[x];
                $("#list-word-in-sug-cat").append('<p class="text" data-source="new-lesson" data-category="'+ idp +'" data-subcategory="'+ idc +'" data-word="'+ w.id +'"  onclick="tellMeWordFrom(\'' + cs + '\',' + w.id + ', this)">' + i + '. ' + t.name + '<span>' + w.name + '</span></p>');
            }
        });
    });
}

/* END GET CAT LIST */

/* GET SUBCAT LIST */
var parent = false;
var firstGenerationCat = true;

function getSubCatList(idCat) {
    getNotice();
    var idLang = $("#myLang").val();
    parent = idCat;
    /**/
    var result = null;
    $.ajax({
        url: "date/" + idLang + "/" + idCat + "/subcat.json",
        type: 'get',
        dataType: 'html',
        async: false,
        success: function (data) {
            result = showSubCatList(data, idCat);
        }
    });
    return result;
}

function showSubCatList(s, parentId) {
    var cats = JSON.parse(s);
    var tmp = '<div class="list-of-subcat">';
    for (var x in cats) {
        var cat = cats[x];
        var cl = "";
        var catSgn = parentId + "/" + cat.id;
        if (dayJSON.skiped.indexOf(catSgn) >= 0) {
            cl = "missingCat";
        }
        if (learnedCat.indexOf(catSgn) >= 0) {
            cl = "learnedCat";
        }
        if (inProgressCat.indexOf(catSgn) >= 0) {
            cl = "inProgressCat";
        }
        cl2 = (cat.audio == true || isPayedPro == true) ? '' : 'no-audio';
        tmp += '<p class="text setCat ' + cl + ' ' + cl2 + '" onclick="getThisCatAsSug(this);" data-name="' + cat.name + '" data-parent="' + parentId + '" data-subcat="' + cat.id + '" data-pos="' + cat.id + '"><strong>' + (cat.name).substring(0, 2) + '</strong> ' + (cat.name).substring(2) + '<span class="inProgressCatInfo">' + getTrans(t_during_learning) + '</span> <span class="missingCatInfo">' + getTrans(t_lesson_skipped) + '</span> <span class="learnedCatInfo">' + getTrans(t_learned_lesson) + '</span></p>';
        if (firstGenerationCat) $("#cat-list .list").append('<li><p class="cat-name" data-id="' + cat.id + '" data-par="' + parentId + '">' + cat.name + '</p></li>');
    }
    tmp += '</div>';
    subcats = tmp;
    return tmp;
}

var inProgressCatcopyForBackBTN = [];

/* END GET SUBCAT LIST */
function setNewCat(c, s) {
    toLearn[8] = c + "/" + s;
    toLearn[9] = c + "/" + s;
    setTimeout(function () {
        srt = $("#nrDayFiled").text();

        toLearnJSONcopyForBackBTN = JSON.parse(JSON.stringify(toLearnJSON));
        toLearnJSON.push({"subid": s, "catid": c, "start": srt});

        inProgressCatcopyForBackBTN = inProgressCat.slice();
        inProgressCat.push(c + "/" + s);
    }, 150);

    /*datesJSON = toLearnJSON;
	srcSave = path() + "save.json";
	saveFile(); */  //ODKOMENTOWAĆ POTEM
}

function showtoLearn() {
    for (var i = 0; i < 10; i++) ;
    //(i + ")" + toLearn[i]);
}

/* GET WORD LIST */
var idWord = false;
var nameWord = false;

function getWordList() {
    var idLang = $("#myLang").val();
    var idParentCat = $("#myParentCat").val();
    var idSubCat = $("#myCat").val();
    var idLernLang = $("#learnLang").val();
    var words = false;
    var trans = false;
    $.get("date/" + idLang + "/" + idParentCat + "/" + idSubCat + "/words.json", function (result) {
        words = result;
        $.get("date/" + idLernLang + "/" + idParentCat + "/" + idSubCat + "/words.json", function (trans) {
            showWordList(words, trans);
        });
    });
}

var words, trans;

function showWordList(w, t) {
    words = JSON.parse(w);
    trans = JSON.parse(t);
    isFirstCycle = false;
    if (isFirstCycle) {
        $("#words").html("");
        var tmp = "";
        for (var x in words) {
            nameWord = false;
            var word = words[x];
            var tran = trans[x];
            tmp += '<div class="word" data-id="' + word.id + '" data-check="1" onclick="checkWord(this);"><table><tr><td><p class="text">' + word.name + '</p></td><td rowspan="2"><img src="img/check.png"></td></tr><tr><td><p class="text">' + tran.name + '</p></td></tr></table></div>';
        }
        $("#words").html(tmp);
        isFirstCycle = false;
    } else {
        getNavWordList();
    }
}

/* END GET WORD LIST */

/* GET NAV WORD LIST */
function getNavWordList() {
    $("#nav-words-container").text("");
    var i = 0;
    var firstId = -1;
    if (isFirstCycle) {
        $(".word").each(function (index) {
            if ($(this).attr('data-check') != 0) {
                i++;
                var id = $(this).data('id');
                if (i == 1) {
                    firstId = id;
                    setActWord(id);
                }
                //$("#nav-words-container").append('<p ontouchstart="setWordToLearn(' + id + ', this)" data-word-id="' + id + '"><img src="img/nav-bg.png" class="no-activ-img"><img src="img/nav-bg-activ.png" class="activ-img"><span>' + i + '</span></p>');
                //$("#nav-words-container").append('<p data-word-id="' + id + '"><img src="img/nav-bg.png" class="no-activ-img"><img src="img/nav-bg-activ.png" class="activ-img"><span>' + i + '</span></p>');
                $("#nav-words-container").append('<p data-word-id="' + id + '"><img src="img/' + i + '.png" class="no-activ-img"><img src="img/' + i + '.png" class="activ-img"></p>');
            }
        });
        isFirstCycle = false;
        setTimeout(function () {
            setNavWordPosition(0);
            $("#nav-words-container p").removeClass("activ");
            $("#nav-words-container p").removeClass("pulse");
            $("#nav-words-container p").eq(0).addClass("activ");
            $("#nav-words-container p").eq(0).addClass("pulse");
        }, 50);
    } else {
        for (var x in words) {
            var word = words[x];
            var id = word.id;
            i++;
            if (i == 1) {
                firstId = id;
                setActWord(id);
            }
            //$("#nav-words-container").append('<p ontouchstart="setWordToLearn(' + id + ', this)" data-word-id="' + id + '"><img src="img/nav-bg.png" class="no-activ-img"><img src="img/nav-bg-activ.png" class="activ-img"><span>' + i + '</span></p>');
            //$("#nav-words-container").append('<p data-word-id="' + id + '"><img src="img/nav-bg.png" class="no-activ-img"><img src="img/nav-bg-activ.png" class="activ-img"><span>' + i + '</span></p>');
            $("#nav-words-container").append('<p data-word-id="' + id + '"><img src="img/' + i + '.png" class="no-activ-img"><img src="img/' + i + '.png" class="activ-img"></p>');
        }
        setTimeout(function () {
            setNavWordPosition(0);
            $("#nav-words-container p").removeClass("activ");
            $("#nav-words-container p").removeClass("pulse");
            $("#nav-words-container p").eq(0).addClass("activ");
            $("#nav-words-container p").eq(0).addClass("pulse");
        }, 50);
    }
}

function setNavWordPosition(i, k) {
    var k = k || 3;
    var j;
    if (k == 3) {
        if (i == 0) j = 3;
        else {
            j = i + 2;
            i--;
        }
    } else if (k == 1) {
        j = i + 1;
    } else if (k == 2) {
        j = i + 1;
        i--;
    }

    $('#nav-words-container p').hide().slice(i, j).show();
}

/*SET WORD TO LEARN*/
function setWordToLearn(id, obj) {
    $("#nav-words-container p").removeClass("activ");
    $(obj).addClass("activ");
    $("#word-lern-1").fadeOut().fadeIn();
    var curWord = setWordById(id);
    var curTrans = setTransById(id);
    var curMyNote = "moja notatka";
    setNoteById(id);
    $("#my-text").attr("data-id", id);
    $("#idWord").val(id);
    $("#word-lern-1").attr("data-id", id);
    $("#word-lern-1").attr("data-word", curWord);
    $("#word-lern-1").attr("data-trans", curTrans);
    $("#my-trans").val("");
    $("#my-trans").focus();

    var index = $("#nav-words-container p.activ").index();
    setNavWordPosition(index);
    setTimeout(tellMe, 100);
}

function nextWord() {
    $('.confirm-swipe').hide();
    $("#my-trans").focus();
    //saveNotice();
    var length = $("#nav-words-container p").length;
    var index = $("#nav-words-container p.activ").index() + 1;
    if (length <= index) console.log("Wszystkiego już się nauczyłeś:)");
    else {
        var id = ($("#nav-words-container p").eq(index)).data('word-id');
        setWordToLearn(id, $("#nav-words-container p").eq(index));
        setNavWordPosition(index);
    }
}

function setWordById(id) {
    $("#idWord").val(id);
    for (var x in trans) {
        var word = trans[x];
        if (word.id == id) {
            act_word = word.name;
        }
    }
}

function setNoteById(id) {
    act_text = "";
    var idLang = $("#myLang").val();
    var idParentCat = $("#myParentCat").val();
    var idSubCat = $("#myCat").val();
    var idLernLang = $("#learnLang").val();
    var tmp = idLang + "\\" + idParentCat + "\\" + idSubCat + "\\" + idLernLang + "\\" + id;

    for (var x in noticeJSON) {
        var notice = noticeJSON[x];
        if (notice.word == tmp) {
            act_text = notice.notice;
            return;
        }
    }
}

function setTransById(id) {
    for (var x in words) {
        var word = words[x];
        if (word.id == id) {
            act_trans = word.name;
        }
    }
}

function checkMySelf() {
    $("#word-lern-1").hide();
    $("#confirm-my").text($("#my-trans").val());
    $(".confirm-swipe").show();
    $(".confirm-swipe table").show();
    $(".confirm-swipe table").css({top: "0px"});
    $('.confirm-swipe table').removeClass('good');
    $('.confirm-swipe table').removeClass('bad');
}

var blockClear = false;

function clearDraggableField() {
    if (!blockClear) {
        $(".confirm-swipe table").show();
        setTimeout(function () {
            $(".confirm-swipe").removeClass('flipper-hide');
            $('.confirm-swipe table').removeClass('good');
            $('.confirm-swipe table').removeClass('bad');
            $('.confirm-swipe table').removeClass('good-right');
            $('.confirm-swipe table').removeClass('bad-right');
            $('.confirm-swipe table').removeClass('goLeft');
            $('.confirm-swipe table').removeClass('goRight');
            setTimeout(function () {
                antyNaparzanka = false;
            }, 500);
        }, 50);
    }
}

/*END SET WORD TO LEARN*/
/*PLAY SOUND*/
var my_media;

function tellMe() {
    if (my_media != null) {
        my_media.stop();
        my_media.stopRecord();
        my_media.release();
        my_media = null;
    }
    var id = $("#idWord").val();
    var idLang = $("#learnLang").val();
    var idParentCat = $("#myParentCat").val();
    var idSubCat = $("#myCat").val();
    var sygn = idParentCat + "/" + idSubCat;

    var src = '/android_asset/www/date/no_sound.mp3';
    if(canTellThisWord(sygn, id) === true) {
        src = '/android_asset/www/date/' + idLang + "/" + sygn + "/sound/" + id + ".mp3";
    }

    setTimeout(function () {
        if (my_media != null) {/*jak coś to do usunięcia*/
            my_media.stop();
            my_media.stopRecord();
            my_media.release();
            my_media = null;
        }

        my_media = new Media(src,
            // success callback
            function () { /*this.release();*/
            },
            // error callback
            function (err) { /*console.log("M: " + err.message + " - " + err.code);*/
            }
        );
        // Play audio
        my_media.play();
    }, 100);
}

function stopTelling() {
    if (my_media != null) {
        my_media.stop();
        my_media.stopRecord();
        my_media.release();
        my_media = null;
    }
}

function tellMeWord(sygn, id) {
    if (my_media != null) {
        my_media.stop();
        my_media.stopRecord();
        my_media.release();
        my_media = null;
    }
    var idLang = $("#learnLang").val();

    var src = '/android_asset/www/date/no_sound.mp3';
    if(canTellThisWord(sygn, id) === true) {
        src = '/android_asset/www/date/' + idLang + "/" + sygn + "/sound/" + id + ".mp3";
    }
    setTimeout(function () {
        if (my_media != null) {/*jak coś to do usunięcia*/
            my_media.stop();
            my_media.stopRecord();
            my_media.release();
            my_media = null;
        }

        my_media = new Media(src,
            // success callback
            function () { /*this.release();*/
            },
            // error callback
            function (err) { /*console.log("M: " + err.message + " - " + err.code);*/
            }
        );
        // Play audio
        my_media.play();
    }, 100);
}

/*END PLAY SOUND*/

/*COPY FIRST PATCH*/
function copyFirstPath() {
    asset2sd.copyDir({
            asset_directory: "www/firstPatch",
            destination_directory: mainPath
        },
        function () {
            if (isPremium) {
                copyFirstPathPremium();
            }
        },
        function () {
            console.log('fail');
        }
    );
}

function copyFirstPathPremium() {
    var demoPathsrc = demoPath();
    copyFileFromDemo(demoPathsrc, 'lang.json', false);
    copyFileFromDemo(demoPathsrc, 'day.json', false);
    copyFileFromDemo(demoPathsrc, 'notice.json', false);
    copyFileFromDemo(demoPathsrc, 'liked.json', false);
    copyFileFromDemo(demoPathsrc, 'save.json', true);
}

function copyFileFromDemo(srcPath, nameFile, lastfile) {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fileSystem) {
        fileSystem.root.getFile((srcPath + nameFile), {create: false}, function (fileEntry) {
            fileSystem.root.getDirectory(premiumPath(), {create: true}, function (dirEntry) {
                fileEntry.copyTo(dirEntry, nameFile,
                    function () {
                        if (lastfile) {
                            //pokazujemy info, że progress został pomyślnie skopiowany z wersji demo i jak chce się uczyć pominiętych lekcji to może
                            showAfterCopyToPremiumConfirm();
                            /*
							setTimeout(function(){
								location.reload();
							}, 100);
							*/
                        }
                    },
                    function (err) {
                        console.log("Error: " + err.toString());
                    }
                );
            }, function (err) {
                console.log("Error: " + err.toString());
            });
        }, function (err) {
            //Tutaj wiemy, że tam nie ma takiego pliku, nie ma zaintalowanej wersji demo
            if (nameFile == 'lang.json') {
                $("#first-use-loading-page").hide();
                startLearn = true; //po tutorialu zacznie naukę
                getLangList(); //wybierz swój język
                $("#choose-lang").show(); //zapisz język jest w funciton setLang w index.html
            }
        });
    }, function (err) {
        console.log("Error: " + err.toString());
    });
}


function showAfterCopyToPremiumConfirm() {
    navigator.notification.confirm(
        getTrans(t_after_premium_copy_text),
        showAfterCopyToPremiumConfirmCallBack,
        getTrans(t_after_premium_copy_title),
        getTrans(t_after_premium_copy_ok)
    );
}

function showAfterCopyToPremiumConfirmCallBack(button) {
    if (button == 1) {
        setTimeout(function () {
            location.reload();
        }, 100);
    } else {
        setTimeout(function () {
            location.reload();
        }, 100);
    }
}

/*END TELL ME*/

/*START SAVE NOTATION*/
function saveNotice(text) {
    if (text == "") return;
    act_text = text;
    var idLang = $("#myLang").val();
    var idParentCat = $("#myParentCat").val();
    var idSubCat = $("#myCat").val();
    var idLernLang = $("#learnLang").val();
    var id = $('#idWord').val();

    var tmp = idLang + "\\" + idParentCat + "\\" + idSubCat + "\\" + idLernLang + "\\" + id;
    var add = false;

    if (noticeJSON.length == 0) {
        logEventInServer('write hint', {text: text, category: idParentCat, subcategory:idSubCat, word: id});
        noticeJSON.push({"word": tmp, "notice": text});
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSN, failN);
    } else {
        for (var x in noticeJSON) {
            var notice = noticeJSON[x];
            if (notice.word == tmp) {
                if (notice.notice != text) {
                    logEventInServer('write hint', {text: text, category: idParentCat, subcategory:idSubCat, word: id});
                }
                notice.notice = text;
                add = true;
            }
            if (x == (noticeJSON.length - 1)) {
                if (!add) {
                    logEventInServer('write hint', {text: text, category: idParentCat, subcategory:idSubCat, word: id});
                    noticeJSON.push({"word": tmp, "notice": text});
                }
                window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSN, failN);
            }
        }
    }
}

function gotFSN(fileSystem) {
    var srcFileNotice = path() + "notice.json";
    fileSystem.root.getFile(srcFileNotice, {create: false}, gotFileEntryN, failN);
}

function gotFileEntryN(fileEntry) {
    fileEntry.createWriter(gotFileWriterN, failN);
}

function gotFileWriterN(writer) {
    writer.onwrite = function (evt) {
        console.log("write success");
    };

    writer.write(JSON.stringify(noticeJSON));
    writer.abort();
}

function failN(error) {
    console.log("error : " + error.code);
}

/*END SAVE NATATION*/
/*START ALGORYTHM MANAGAMENT*/
var act_word = "";
var act_trans = "";
var act_text = "";

function setWordToMethod(idM) {
    $(".learnMethod").hide();
    $(".bad-bad").removeClass('activ');
    setTimeout(function () {
        if (idM == 6 || (idM == 1 && !thirdCycle)) $(".bad-bad").addClass('activ');
        else $(".bad-bad").removeClass('activ');
    }, 800);
    if (act_text != "") $(".remind-img").show();
    else $(".remind-img").hide();
    switch (idM) {
        case 1:
            $(".show-hidden-word").show(); //zmiana
            $("#confirm-correct-1").hide(); //zmiana
            $("#confirm-correct-1").html('<p>' + act_word + '</p>'); //zmiana
            $("#confirm-trans-1").html('<p>' + act_trans + '</p>');
            $("#confirm-text-1").val(act_text);
            break;
        case 2:
            $("#confirm-correct-2").html('<p>' + act_word + '</p>');
            $("#confirm-trans-2").html('<p>' + act_trans + '</p>');
            $("#confirm-text-2").val(act_text);
            break;
        case 3:
            $("#confirm-text-3").val(act_text);
            $("#question-3").val("");
            break;
        case 4:
            tellMe();
            $("#confirm-correct-4").html('<span>' + act_word + '</span>');
            $(".show-hidden-word").show(); //zmiana
            $("#confirm-trans-4").hide(); //zmiana
            $("#confirm-trans-4").html('<span>' + act_trans + '</span>'); //zmiana
            $("#confirm-text-4").val(act_text);
            break;
        case 5:
            $("#confirm-text-5").val(act_text);
            $("#question-5").val("");
            break;
        case 6:
            $("#confirm-correct-6").html('<p>' + act_word + '</p>');
            $(".show-hidden-word").show(); //zmiana
            $("#confirm-trans-6").hide(); //zmiana
            $("#confirm-trans-6").html('<p>' + act_trans + '</p>'); //zmiana
            $("#confirm-text-6").val(act_text);
            break;
        default:
            console.log("error");
    }
    $(".support-word-in-speach p").text(act_word);
    $("#word-lern-" + idM).show();

    $(".nbWordInCycle").text((learnedWordsInCat + 1) + "/" + countWordsToLearnInThisCycle);
}

function setActWord(id) {
    $('#idWord').val(id);
    setWordById(id);
    setNoteById(id);
    setTransById(id);
    setActuLikedIcon();
}

var round = 1;
var nbMethod = 2;
var nbStep = 0;
var canNextStep = 1;
var noLerntStep = 0;
var ileSnd = 0;
var ileThd = 0;

function nextStepBlock() {
    canNextStep = 0;
}

function noLearnt() {
    canNextStep = 0;
    setTimeout(function () {
        clearDraggableField();
    }, 100);
    noLerntStep = 1;
    if (noLerntStep == 0) {
        whereGo = 0;
        setWordToMethod(3);
        noLerntStep = 1;
    } else {
        theSameMethod = true;
        whereGo = -1;
        setWordToMethod(4);
        noLerntStep = 0;
        canNextStep = 2;
    }
}

var noPlus = 0;
var prepareToThird = 1;
var isPreparetoFirst = false;
var readyToSaveNotice = false;
var whereGo = 0;
var noFlipIfWrong = false;
var lastWordSecondRound = true;
var repeatSec = 1;
var repeatThd = 1;
var s_nowe = 0;
var t_nowe = 0;
var id_powt = -1;
var s_bylo = 0;
var t_bylo = 0;
var stepow = 0;
var ile_s = 0;
var ile_t = 0;
var last_r_s = -1;
var theSameMethod = false;
var antyNaparzanka = false;

function getAntyNaparzanka() {
    return antyNaparzanka;
}

function setAntyNaparzankaToTrue() {
    antyNaparzanka = true;
}

function nextStep() {
    countOfWrongRecognized = 0;
    //volumeTest();
    antyNaparzanka = true;
    hideBars();
    //StatusBar.hide();
    backToNormalStateNote();
    $(".recTextWrap").hide();
    $(".recText").text('');
    $(".learnMethod").removeClass('badRec');
    $(".learnMethod").removeClass('goodRec');
    $(".cloud-again").hide();
    $(".cloud-next-task").hide();
    $(".support-word-in-speach").hide();

    updateProgressBar();
    /*
	if(readyToSaveNotice){
		saveNotice($("#confirm-text-"+nbMethod).val());
	}else{
		readyToSaveNotice = true;
	}
	*/
    if (round == 3) {
        if (canNextStep == 2) {
            noPlus = 1;
            canNextStep = 1;
            nbMethod = 4;
            nbStep = 0;
        }
        if (canNextStep == 0) {
            noLearnt();
            return;
        }
    }
    setTimeout(function () {
        clearDraggableField();
    }, 300);
    if (firstCycle) {
        if (!isPreparetoFirst) {
            whereGo = -1;
            setActWord(($("#nav-words-container p").eq(0)).data('word-id'));
            $("#nav-words-container p").eq(0).addClass("activ");
            $("#nav-words-container p").eq(0).addClass("pulse");
            setWordToMethod(2)
            setNavWordPosition(0);
            isPreparetoFirst = true;
            tellMe();
        } else {
            if (!canNextStep) {
                whereGo = 0;
                nbMethod = 2;
                setWordToMethod(2);
                canNextStep = true;
                tellMe();
                return;
            }
            /*
			if(nbMethod == 2){
				whereGo = -1;
				nbMethod = 1;
				setWordToMethod(1);
			}else
			*/
            if (nbMethod == 1 || nbMethod == 2) {
                whereGo = -1;
                nbMethod = 1;
                var length = $("#nav-words-container p").length;
                var index = $("#nav-words-container p.activ").index() + 1;
                //learnedWords++;
                if (length <= index) {
                    round = 2;
                    firstCycle = false;
                    nextStep();
                    return;
                } else {
                    var id = ($("#nav-words-container p").eq(index)).data('word-id');
                    setActWord(id);
                    setNavWordPosition(index);
                    $("#nav-words-container p").removeClass("activ");
                    $("#nav-words-container p").removeClass("pulse");
                    $("#nav-words-container p").eq(index).addClass("pulse");
                    $("#nav-words-container p").eq(index).addClass("activ");
                    setTimeout(function () {
                        setWordToMethod(2);
                        tellMe();
                    }, 50);
                }
            }
        }
    } else if (secondCycle) {
        if (round == 2) {
            lastWordSecondRound = true;
            whereGo = -1;
            var id = ($("#nav-words-container p").eq(0)).data('word-id');
            setActWord(id);
            setNavWordPosition(1);
            $("#nav-words-container p").removeClass("activ");
            $("#nav-words-container p").removeClass("pulse");
            $("#nav-words-container p").eq(0).addClass("activ");
            $("#nav-words-container p").eq(0).addClass("pulse");
            setTimeout(function () {
                setWordToMethod(4);
                tellMe();
            }, 100);
            theSameMethod = true;
            round = 3;
            nbMethod = 4;
        } else if (round == 3) {
            theSameMethod = false;
            noFlipIfWrong = false;
            if (nbMethod == 4 && nbStep == 0) {
                //saveNotice($("#confirm-text-4").val());
                whereGo = 1;
                var length = $("#nav-words-container p").length;
                if (true) var index = $("#nav-words-container p.activ").index() + 1;
                else {
                    var index = $("#nav-words-container p.activ").index();
                    noPlus = 0;
                }
                if (length <= index) {
                    /*if(lastWordSecondRound){
						index--;
						setWordToMethod(6);
						whereGo = -1;
						var id = ($("#nav-words-container p").eq(index)).data('word-id');
						setActWord(id);
						lastWordSecondRound = false;
					}else{*/
                    $("#nav-words-container p").removeClass("activ");
                    $("#nav-words-container p").removeClass("pulse");
                    $("#nav-words-container p").eq(0).addClass("activ");
                    $("#nav-words-container p").eq(0).addClass("pulse");
                    round = 4;
                    //nextStep();
                    secondCycle = false;
                    nextStep();
                    return;
                    //}
                } else {
                    var id = ($("#nav-words-container p").eq(index)).data('word-id');
                    setActWord(id);
                    setNavWordPosition(index);
                    $("#nav-words-container p").removeClass("activ");
                    $("#nav-words-container p").removeClass("pulse");
                    $("#nav-words-container p").eq(index).addClass("activ");
                    $("#nav-words-container p").eq(index).addClass("pulse");
                    setTimeout(function () {
                        setWordToMethod(4);
                        tellMe();
                    }, 100);
                    nbMethod = 4;
                    nbStep = 1;
                }
            } else if (nbMethod == 4 && nbStep != 0) {
                whereGo = 0;
                //saveNotice($("#confirm-text-4").val());
                var index = $("#nav-words-container p.activ").index() - 1;
                var id = ($("#nav-words-container p").eq(index)).data('word-id');
                setActWord(id);
                //setNavWordPosition(index);
                $("#nav-words-container p").removeClass("activ");
                $("#nav-words-container p").removeClass("pulse");
                $("#nav-words-container p").eq(index).addClass("activ");
                $("#nav-words-container p").eq(index).addClass("pulse");
                setTimeout(function () {
                    setWordToMethod(1);
                }, 100);
                //nbMethod = 1;
                //nbStep = 1;
                nbStep = 2;
                nbMethod = 6;
                whereGo = -1;
                theSameMethod = true;
            } else if (nbMethod == 1 && nbStep == 1) {
                whereGo = -1;
                nbMethod = 6;
                setWordToMethod(6);
                nbStep = 2;
                noFlipIfWrong = true;
            } else if (nbMethod == 6) {
                var index = $("#nav-words-container p.activ").index() + 1;
                var length = $("#nav-words-container p").length;
                if (index < length - 1) {
                    $("#nav-words-container p").removeClass("activ");
                    $("#nav-words-container p").eq(index).addClass("activ");
                    whereGo = -1;
                    nbMethod = 4;
                    nbStep = 0;
                    nextStep();
                    return;
                } else {
                    whereGo = 0;
                    var index = $("#nav-words-container p.activ").index() + 1;
                    var id = ($("#nav-words-container p").eq(index)).data('word-id');
                    setActWord(id);
                    $("#nav-words-container p").removeClass("activ");
                    $("#nav-words-container p").removeClass("pulse");
                    $("#nav-words-container p").eq(index).addClass("activ");
                    $("#nav-words-container p").eq(index).addClass("pulse");
                    setTimeout(function () {
                        setWordToMethod(1);
                    }, 100);
                    nbStep = 0;
                    nbMethod = 4;
                    whereGo = -1;
                    theSameMethod = true;
                }
            } else if (nbMethod == 1 && nbStep == 2) {
                whereGo = -1;
                nbMethod = 4;
                nbStep = 0;
                nextStep();
                return;
            }
        }
    } else if (thirdCycle) {
        if (round == 4) {
            //if(canNextStep == 0){
            /*canNextStep = 1;
				if(id_powt > 0){
					if(id_powt == snd_id){
						ile_s = 2;
					}else if(id_powt == thd_id){
						ile_t = 2;
					}
				}else{	*/
            var index = $("#nav-words-container p.activ").index();
            var id = ($("#nav-words-container p").eq(index)).data('word-id');
            /*if(snd_id > 0){
						thd_id = id;
						t_nowe = 1;
						ile_t = 2;
					}else{
						snd_id = id;
						s_nowe = 1;
						ile_s = 2;
					}
				}*/
            //}
            //updateThirdNav();
            if (nbStep == 0) {
                if (prepareToThird != 1) {
                    var length = $("#nav-words-container p").length;
                    var index = $("#nav-words-container p.activ").index() + 1;
                    if (length <= index) {
                        round = 5;
                        nextStep();
                        return;
                    } //zmiana
                    $("#nav-words-container p").removeClass("activ");  //zmiana
                    $("#nav-words-container p").removeClass("pulse");  //zmiana
                    $("#nav-words-container p").eq(index).addClass("activ");  //zmiana
                    $("#nav-words-container p").eq(index).addClass("pulse");  //zmiana
                } else {
                    prepareToThird = 0;
                }
                whereGo = 0;
                var index = $("#nav-words-container p.activ").index();
                var id = ($("#nav-words-container p").eq(index)).data('word-id');
                setActWord(id);
                setNavWordPosition(index);
                setTimeout(function () {
                    setWordToMethod(1);
                }, 100);
                nbMethod = 5;
                //nbStep = 1;
                nbStep = 0; //zmiana
                whereGo = -1; //zmiana
            } else if (nbStep == 1) {
                whereGo = -1;
                $("#nav-words-container p.activ").eq(index).addClass("pulse");
                //saveNotice($("#confirm-text-1").val());
                var id = ($("#nav-words-container p").eq(index)).data('word-id');
                setTimeout(function () {
                    setWordToMethod(6);
                }, 100);
                nbStep = 0;
            } else {
                round = 5;
                thirdCycle = false;
                nextStep();
                return;
            }
        } else if (round == 5) {
            thirdCycle = false;
            nextStep();
            return;
        }
    } else {
        nextPack();
    }
}

function nextPack() {
    blockClear = true;
    $('.confirm-swipe table').hide();
    $(".left-time").text((countCatsToLearnToday - (learnetCatToday - 1)) * minCat);

    var percent = Math.round((learnetCatToday - 1) / (countCatsToLearnToday) * 100);
    $("#progess-btn-stan-end").addClass('p' + percent);
    removeProgressClassMin($("#progess-btn-stan-end"), percent);

    setTimeout(function () {
        blockClear = false;
        //$('.confirm-swipe table').addClass('goLeft');
        if (isRepeatCycle) {
            $(".timeLernedToday").text((learnetCatToday - 1) * minCat);
            $(".allTimeToday").text(countCatsToLearnToday * minCat);
            $('section').hide();
            $("#end-cat").show();
            logEventInServer('end repetition', getDataAboutCurrentWordToLog());
            setTimeout(function () {
                $("#end-cat").removeClass('next-cat-left');
                $("#learn-container").addClass('next-cat-left');
            }, 50);
            isRepeatCycle = false;
        } else {
            $("#end-cat").addClass('next-cat-right');
            setTimeout(function () {
                $("#end-cat").hide();
                $("#end-cat").removeClass('next-cat-right');
                $("#end-cat").addClass('next-cat-left');
                packControler();
            }, 800);
        }
    }, 500);
}

var fst_id = 0;
var snd_id = 0;
var thd_id = 0;
var temid = 0;
var fin_id = 0;
var repeatFstRound = true;

//var repeatSecRound = false;
function repeatThrid(id, met) {
    if (met == 6) whereGo = -1;
    else whereGo = 0;
    setTimeout(function () {
        setActWord(id);
        setTimeout(function () {
            setWordToMethod(met);
            pulseThdNav(id);
        }, 5);
    }, 100);
}

function updateThirdNav() {
    var i = 1;
    var ids = [];
    ids.push(snd_id);
    ids.push(thd_id);
    $("#nav-words-container-thd p").hide();
    $("#nav-words-container-thd p").attr('data-word-id', 0);
    $("#nav-words-container p").each(function () {
        var id = $(this).attr('data-word-id');
        var src = $(this).children('img').attr('src');
        for (k = 0; k < ids.length; k++) {
            if (id == ids[k]) {
                $("#nav-th-" + i).children('img').attr('src', src);
                $("#nav-th-" + i).attr('data-word-id', id);
                $("#nav-th-" + i).show();
                i++;
                ids.splice(k, 1);
                break;
            }
        }
    });
}

function pulseThdNav(idW) {
    setTimeout(function () {
        $("#nav-words-container p").removeClass('pulse');
        $("#nav-words-container-thd p").removeClass('pulse');
        $("#nav-words-container-thd p").removeClass("activ");
        $("#nav-words-container-thd p").each(function () {
            var id = $(this).attr('data-word-id');
            if (idW == id) {
                $(this).addClass('pulse');
                $(this).addClass('activ');
            }
        });
    }, 200);
}

/*END ALGORYTHM MANAGAMENT*/

function showAllNote() {
    showNote(1);
    showNote(2);
    showNote(3);
    showNote(4);
    showNote(5);
    showNote(6);
}

function showNote(x) {
    var target = "#l-n-" + x;
    var target2 = "#l-c-" + x;
    var targetE = "#l-e-" + x;
    $(target2).hide();
    if ($(target).is(":visible") == true) {
        $(target).hide();
        $(targetE).show();
        showTrans(x);

        var t = $("#learn-panel .learnMethod:visible").attr('id');
        var nb = t.substr(t.length - 1);
        if(nb == x) {
            logEventInServer('close hint', {day: dayJSON.day, category: $("#myParentCat").val(), subcategory: $("#myCat").val(), word: $("#idWord").val(), notice: $("#confirm-text-"+nb).val()});
        }
    } else {
        $(targetE).hide();
        $(target).show();

        var t = $("#learn-panel .learnMethod:visible").attr('id');
        var nb = t.substr(t.length - 1);
        if(nb == x) {
            logEventInServer('show hint', {day: dayJSON.day, category: $("#myParentCat").val(), subcategory: $("#myCat").val(), word: $("#idWord").val(), notice: $("#confirm-text-"+nb).val()});
        }
    }
}

function showTrans(x) {
    var target = "#l-n-" + x;
    var target2 = "#l-c-" + x;
    var targetE = "#l-e-" + x;
    $(target).hide();
    if ($(target2).is(":visible") == true) {
        $(target2).hide();
        $(targetE).show();
    } else {
        $(targetE).hide();
        $(target2).show();
    }
}

function backToNormalStateNote() {
    $("#l-n-1").hide();
    $("#l-n-2").hide();
    $("#l-n-3").hide();
    $("#l-n-4").hide();
    $("#l-n-5").hide();
    $("#l-n-6").hide();
    $("#l-e-1").hide();
    $("#l-e-2").hide();
    $("#l-e-3").hide();
    $("#l-e-4").hide();
    $("#l-e-5").hide();
    $("#l-e-6").hide();
    $("#l-t-1").show();
    $("#l-t-2").show();
    $("#l-t-3").show();
    $("#l-t-4").show();
    $("#l-t-5").show();
    $("#l-t-6").show();
    $("#l-c-1").show();
    $("#l-c-2").show();
    $("#l-c-3").show();
    $("#l-c-4").show();
    $("#l-c-5").show();
    $("#l-c-6").show();
    hideKeyboard();
    hideHoverNoteBtn('.note-btn');
}

function hideKeyboard() {
    $("#l-n-1").blur();
    $("#l-n-2").blur();
    $("#l-n-3").blur();
    $("#l-n-4").blur();
    $("#l-n-5").blur();
    $("#l-n-6").blur();
}

function showNoteForTut(x) {
    var target = "#t-l-n-" + x;
    var target2 = "#t-l-t-" + x;
    var targetE = "#t-l-e-" + x;
    $(target2).hide();
    if ($(target).is(":visible") == true) {
        $(target).hide();
        $(targetE).show();
    } else {
        $(targetE).hide();
        $(target).show();
    }
}

function showTransForTut(x) {
    var target = "#t-l-n-" + x;
    var target2 = "#t-l-t-" + x;
    var targetE = "#t-l-e-" + x;
    $(target).hide();
    if ($(target2).is(":visible") == true) {
        $(target2).hide();
        $(targetE).show();
    } else {
        $(targetE).hide();
        $(target2).show();
    }
}

function tellMeNow(obj) {
    //var par = $(obj).parent().parent();
    //if(parseInt(par.css('top')) == 0){
    tellMe();
    //}
}

function prepareGlobalForCycle(i) {
    switch (i) {
        case 1:
            $("#nav-words-container-thd p").hide();
            round = 1;
            nbMethod = 2;
            isPreparetoFirst = false;
            firstCycle = true;
            secondCycle = false;
            thirdCycle = false;
            break;
        case 2:
            $("#nav-words-container-thd p").hide();
            round = 2;
            nbMethod = 2;
            nbStep = 0;
            noPlus = 0;
            canNextStep = 1;
            noLerntStep = 0;
            firstCycle = false;
            secondCycle = true;
            thirdCycle = false;
            break;
        case 3:
            $("#nav-words-container-thd p").hide();
            round = 4;
            nbStep = 0;
            canNextStep = 1;
            prepareToThird = 1;
            fst_id = 0;
            snd_id = 0;
            thd_id = 0;
            temid = 0;
            fin_id = 0;
            firstCycle = false;
            secondCycle = false;
            thirdCycle = true;
            repeatSec = 1;
            repeatThd = 1;
            s_nowe = 0;
            t_nowe = 0;
            id_powt = -1;
            s_bylo = 0;
            t_bylo = 0;
            stepow = 0;
            ile_s = 0;
            ile_t = 0;
            last_r_s = -1;
            break;
    }
    $("#nav-words-container p").removeClass("activ");
    $("#nav-words-container p").removeClass("pulse");
    $("#nav-words-container p").eq(0).addClass("activ");
    $("#nav-words-container p").eq(0).addClass("pulse");
}

function addFunction(a, b) {
    if (Number.isInteger(b)) return a + b;
    else return a;
}

var continueLearning = false;
var nameCat;
var newCategoryisSet = false;
var learnetCatToday = 1;
var learnetCatTodayCopytBTN = 1;
var isRepeatCycle = false;
var copyOfLearnArray = [];

function packControler() {
    waintingLearned = 0;
    var endThis = false;
    $("#startDay").hide();
    $("#words-nav").show();
    $("#ok-no-panel").show();

    if (toLearn.reduce(function (a, b) {
        return a + b;
    }, 0) != -10) {
        /*$("#learn-container").show();*/
        setTimeout(function () {
            $("#learn-container").removeClass('next-cat-left');
        }, 500);
    }
    for (var i = 0; i < 10 && !endThis; i++) {
        continueLearning = false;
        if (toLearn[i] != -1) {
            clearNoticeFields();
            setEveryThingToStartCat(toLearn[i]);
            getSubCatName(toLearn[i]);
            endThis = true;
            continueLearning = true;
            switch (i) {
                case 0:
                    clearDraggableField();
                    isRepeatCycle = false;
                    copyOfLearnArray = toLearn.slice();
                    learnedWordsCopy = learnedWords;
                    learnetCatTodayCopytBTN = learnetCatToday;
                    showAd();
                    countWordsToLearnInThisCycle = wordsInOneCat + wordsInOneCat * 2;
                    learnedWordsInCat = 0;
                    prepareGlobalForCycle(1);
                    setTimeout(function () {
                        showStartCat(learnetCatToday, nameCat);
                    }, 100);
                    break;
                case 1:
                    isRepeatCycle = true;
                    prepareGlobalForCycle(2);
                    setTimeout(function () {
                        nextStep();
                    }, 300);
                    learnetCatToday++;
                    break;
                case 2:
                    clearDraggableField();
                    isRepeatCycle = false;
                    copyOfLearnArray = toLearn.slice();
                    learnedWordsCopy = learnedWords;
                    learnetCatTodayCopytBTN = learnetCatToday;
                    showAd();
                    countWordsToLearnInThisCycle = wordsInOneCat + wordsInOneCat * 2;
                    learnedWordsInCat = 0;
                    prepareGlobalForCycle(2);
                    setTimeout(function () {
                        showStartCat(learnetCatToday, nameCat);
                    }, 100);
                    break;
                case 3:
                    isRepeatCycle = true;
                    prepareGlobalForCycle(3);
                    setTimeout(function () {
                        nextStep();
                    }, 300);
                    learnetCatToday++;
                    break;
                case 4:
                    clearDraggableField();
                    isRepeatCycle = false;
                    copyOfLearnArray = toLearn.slice();
                    learnedWordsCopy = learnedWords;
                    learnetCatTodayCopytBTN = learnetCatToday;
                    showAd();
                    countWordsToLearnInThisCycle = wordsInOneCat + wordsInOneCat * 2;
                    learnedWordsInCat = 0;
                    prepareGlobalForCycle(2);
                    setTimeout(function () {
                        showStartCat(learnetCatToday, nameCat);
                    }, 100);
                    break;
                case 5:
                    isRepeatCycle = true;
                    prepareGlobalForCycle(3);
                    setTimeout(function () {
                        nextStep();
                    }, 300);
                    learnetCatToday++;
                    break;
                case 6:
                    clearDraggableField();
                    isRepeatCycle = false;
                    copyOfLearnArray = toLearn.slice();
                    learnedWordsCopy = learnedWords;
                    learnetCatTodayCopytBTN = learnetCatToday;
                    showAd();
                    countWordsToLearnInThisCycle = wordsInOneCat + wordsInOneCat * 2;
                    learnedWordsInCat = 0;
                    prepareGlobalForCycle(2);
                    setTimeout(function () {
                        showStartCat(learnetCatToday, nameCat);
                    }, 100);
                    //learnetCatToday++;
                    break;
                case 7:
                    //clearDraggableField();
                    isRepeatCycle = true;
                    //showAd();
                    //countWordsToLearnInThisCycle = wordsInOneCat;
                    //learnedWordsInCat = 0;
                    prepareGlobalForCycle(3);
                    setTimeout(function () {
                        nextStep();
                    }, 300);
                    //setTimeout(function(){ showStartCat(learnetCatToday, nameCat);}, 100);
                    learnetCatToday++;
                    break;
                case 8:
                    clearDraggableField();
                    isRepeatCycle = false;
                    countWordsToLearnInThisCycle = wordsInOneCat + wordsInOneCat * 2;
                    learnedWordsInCat = 0;
                    learnetCatTodayCopytBTN = learnetCatToday;
                    newCategoryisSet = true;
                    prepareGlobalForCycle(1);
                    setTimeout(function () {
                        nextStep();
                    }, 300);
                    break;
                case 9:
                    isRepeatCycle = false;
                    newCategoryisSet = true;
                    prepareGlobalForCycle(2);
                    setTimeout(function () {
                        nextStep();
                    }, 300);
                    break;
                default:
                    break;
            }
            toLearn[i] = -1;
        }
    }
    if (!continueLearning) {
        if (newCategoryisSet) {
            endTodayLesson = true;
            saveDay();
        } else {
            showAd();
            copyOfLearnArray = toLearn.slice();
            learnedWordsCopy = learnedWords;
            startChoiceNewCategory();
            //startSetNewCategory();
        }
    }

}

function clearNoticeFields() {
    $("#confirm-text-1").val("");
    $("#confirm-text-2").val("");
    $("#confirm-text-3").val("");
    $("#confirm-text-4").val("");
    $("#confirm-text-5").val("");
    $("#confirm-text-6").val("");
}

function setEveryThingToStartCat(cat) {
    var res = cat.split("/");
    var p = res[0];
    var c = res[1];
    $("#myParentCat").val(p);
    $("#myCat").val(c);
    setTimeout(function () {
        getWordList();
    }, 10);
}

function whereGoNow() { //-1 - left, 1- right, 0-no;
    return whereGo;
}

function getsecondCycle() {
    return secondCycle;
}

function getfirstCycle() {
    return firstCycle;
}

function getNoFlipIfWrong() {
    return noFlipIfWrong;
}

function setNoFlipIfWrong(val) {
    noFlipIfWrong = val;
}

function isRoundTwoAndTheSameMethod() {
    return ((round == 3 && theSameMethod) || round == 4 || round == 1);
}

function showStartCat(count, name) {
    removeAllProgressClass($("#progess-btn-stan"));
    $("#start-next-cat").show();
    $("#nav-circle-word").hide();
    $("#learn-container").hide();
    $("#main-text-next-cat").text(count + "/" + countCatsToLearn);
    $("#main-text-next-cat-end").text(count + "/" + countCatsToLearn);
    $(".all-words-to-end-sesion-in-repeat").text(countWordsToLearn - learnedWords);
    $("#name-next-cat").text(name);

    var percent = Math.round(((count - 1) / countCatsToLearn) * 100);
    //$("#progess-btn-stan").addClass('p'+percent);
    $("#progess-btn-per").text(percent + "%");

    setTimeout(function () {
        $("#start-next-cat").removeClass('next-cat-left');
        setTimeout(function () {
            loadProgressBarToFull();
        }, 500);
    }, 500);
}

var ix = 1;

function loadProgressBarToFull() {
    ix = 1;
    smoothLoadProgressBar();
}

function smoothLoadProgressBar() {
    setTimeout(function () {
        $("#progess-btn-stan").addClass('p' + ix);
        ix++;
        if (ix < 101) {
            smoothLoadProgressBar();
        }
    }, 15)
}

function nextCatBtn() {
    logEventInServer('start repetition', {category: $("#myParentCat").val(), subcategory: $("#myCat").val()});
    $("#start-next-cat").addClass('next-cat-right');
    $("#learn-container").addClass('next-cat-left');
    setTimeout(function () {
        $("#nav-circle-word").show();
        $("#learn-container").show();
        setTimeout(function () {
            $("#learn-container").removeClass('next-cat-left');
            removeAllProgress();
        }, 500);
        $("#start-next-cat").hide();
        $("#start-next-cat").removeClass('next-cat-right');
        $("#start-next-cat").addClass('next-cat-left');
        nextStep();
    }, 500);
}

function removeAllProgress() {
    for (var i = 1; i < 102; i++) {
        $("#progess-btn-stan").removeClass('p' + i);
    }
}

var waintingLearned = 0;

function increaseLearned() {
    if (waintingLearned > 0) {
        waintingLearned--;
    } else {
        if (thirdCycle) {
            var bylo = false;
            $("#nav-words-container-thd p").each(function () {
                if ($(this).hasClass('activ')) {
                    bylo = true;
                }
            });
            setTimeout(function () {
                if (!bylo) {
                    learnedWords++;
                    learnedWordsInCat++;
                }
            }, 50);
        } else {
            learnedWords++;
            learnedWordsInCat++;
        }
    }
}

function setWaintingLearned() {
    if (getfirstCycle()) {
        waintingLearned = 1;
    } else if (getsecondCycle()) {
        if (nbMethod == 6) {
            waintingLearned += 3;
        } else {
            if (nbStep == 2) {
                waintingLearned += 0;
            } else {
                waintingLearned += 2;
            }
        }
    }
    if (thirdCycle) {
        var bylo = false;
        $("#nav-words-container-thd p").each(function () {
            if ($(this).hasClass('activ')) {
                bylo = true;
            }
        });
        setTimeout(function () {
            if (!bylo) {
                learnedWords++;
                learnedWordsInCat++;
            }
        }, 50);
    }
}

/*END APP*/
function endLearn() {
    $("#learn-container").addClass('next-cat-right');
    $("#saving-progress-today").addClass('next-cat-right');

    if (todayEndedCat != "") allEndedCats.push(todayEndedCat);
    uniqueallEndedCats = allEndedCats.filter(function (item, pos) {
        return allEndedCats.indexOf(item) == pos;
    });

    $(".allWords").text(dayJSON.words);
    $(".countKMLearned").text(Math.floor((dayJSON.km) * minCat / 60));
    $(".countMinLearned").text(Math.floor((dayJSON.km) * minCat % 60));

    if (allCats.sort().toString() == uniqueallEndedCats.sort().toString() && (inProgressCat.length == 0 || (inProgressCat.length == 1 && inProgressCat[0] == todayEndedCat))) {
        setTimeout(function () {
            //showAd();
            $("#learn-container").hide();
            $("#saving-progress-today").hide();
            $("#end-course").show();
            setTimeout(function () {
                $("#end-course").removeClass('next-cat-left');
                showRating();
            }, 100);
        }, 500);
    } else {
        setTimeout(function () {
            var allStartedCats = allUsedCats.concat(inProgressCat);
            var uniqueallUsedCats = allStartedCats.filter(function (item, pos) {
                return allStartedCats.indexOf(item) == pos;
            });
            if (allCats.sort().toString() == uniqueallUsedCats.sort().toString()) {
                showEndNewMaterialsInfo();
            }

            $("#learn-container").hide();
            $("#saving-progress-today").hide();
            $("#end-panel").show();
            logEventInServer('end day', getDataAboutCurrentWordToLog());
            setTimeout(function () {
                $("#end-panel").removeClass('next-cat-left');
                showRating();
            }, 100);
        }, 500);
    }

}

/*END END APP*/
/*TUTORIAL*/
var stepTut = 1;
var visiblesSectionsBeforeStart;

function startTut() {
    visiblesSectionsBeforeStart = $('body > section:visible:not(.next-cat-left):not(.next-cat-right):not(#new-tutorial):not(#ok-no-panel-TUT):not(#word-lern-2-TUT)');

    var acc = []
    visiblesSectionsBeforeStart.each(function (index, value) {
        acc.push($(this).attr('id'));
    });

    visiblesSectionsBeforeStart.addClass('next-cat-left');
    setTimeout(function () {
        visiblesSectionsBeforeStart.hide();
        $("#new-tutorial").show();
        $("#ok-no-panel-TUT, #word-lern-2-TUT, #popup-TUT-1").show();
        $(".popup-TUT").removeClass('next-cat-left');
        $(".popup-TUT").removeClass('next-cat-right');
        $(".popup-TUT:not(#popup-TUT-1)").addClass('next-cat-right-right');
        $("#popup-TUT-1").removeClass('next-cat-right-right');
        $("#progess-btn-stan-in-cycle-TUT").addClass('full-opacity');

        setTimeout(function () {
            $("body").addClass('tutorial-body-darkness');
            $(".background").addClass('background-tutorial-darkness');
            stepTut = 1;
            $("#choose-lang").hide();
            $(".cursor-TUT").addClass('cursor-TUT-1');
            $("#menu-switch").addClass('half-opacity');

            $("#new-tutorial").removeClass('next-cat-left');
            $("#new-tutorial").removeClass('next-cat-right');
        }, 200);
    }, 500);
}

function nextTutStep() {
    $("#popup-TUT-" + stepTut).addClass('next-cat-left');
    stepTut++;
    removeFullOpacity();
    removeAllCursors();
    setTimeout(function () {
        $("#popup-TUT-" + parseInt(stepTut - 1)).hide();
        $("#popup-TUT-" + parseInt(stepTut - 1)).addClass('next-cat-right-right');
        $("#popup-TUT-" + stepTut).show();
        $("#popup-TUT-" + stepTut).removeClass('next-cat-right-right');
        $(".cursor-TUT").addClass('cursor-TUT-' + stepTut);

        switch (stepTut) {
            case 1:
                $("#progess-btn-stan-in-cycle-TUT").addClass('full-opacity');
                break;
            case 2:
                $("#new-tutorial .mic-container").addClass('full-opacity');
                break;
            case 3:
                $(".star-liked-TUT").addClass('full-opacity');
                break;
            case 4:
                $("#notebtn-TUT").addClass('full-opacity');
                break;
            case 5:
                endTutWrap();
                break;
        }
    }, 800);
}

function removeFullOpacity() {
    $("#new-tutorial-repeat-text span").removeClass('full-opacity');
    $("#progess-btn-stan-in-cycle-TUT").removeClass('full-opacity');
    $("#new-tutorial .mic-container").removeClass('full-opacity');
    $("#notebtn-TUT").removeClass('full-opacity');
    $(".star-liked-TUT").removeClass('full-opacity');
    $("#menu-switch").removeClass('full-opacity');
}

function removeAllCursors() {
    $(".cursor-TUT").removeClass('cursor-TUT-1');
    $(".cursor-TUT").removeClass('cursor-TUT-2');
    $(".cursor-TUT").removeClass('cursor-TUT-3');
    $(".cursor-TUT").removeClass('cursor-TUT-4');
    $(".cursor-TUT").removeClass('cursor-TUT-5');
    $(".cursor-TUT").removeClass('cursor-TUT-6');
    $(".cursor-TUT").removeClass('cursor-TUT-7');
    $(".cursor-TUT").removeClass('cursor-TUT-8');
    $(".cursor-TUT").removeClass('cursor-TUT-9');
}

function updateProgressTut(step) {
    var percent = 100 - Math.round(((step) / (12)) * 100);
    $("#progess-btn-stan-in-cycle-tut2").addClass('p' + percent);
    removeProgressClassMin($("#progess-btn-stan-in-cycle-tut2"), percent);
}

function endTutWrap() {
    $("#menu-switch").removeClass('half-opacity');
    $("body").removeClass('tutorial-body-darkness');
    $(".background").removeClass('background-tutorial-darkness');
    $("#new-tutorial").addClass('next-cat-right');
    $(".popup-TUT").hide();
    $(".popup-TUT").addClass('next-cat-right-right');
    stepTut = 0;
    visiblesSectionsBeforeStart.addClass('next-cat-left');
    setTimeout(function () {
        visiblesSectionsBeforeStart.show();
        setTimeout(function () {
            if (startLearn) {
                //zacznij naukę
                getDay();
                //showStartLessonPage();
                startLearn = false;
            } else {
                //powrót do głównego
                var acc = []
                visiblesSectionsBeforeStart.each(function (index, value) {
                    acc.push($(this).attr('id'));
                });

                visiblesSectionsBeforeStart.removeClass('next-cat-left');
            }
        }, 400);
        $("#new-tutorial").hide();
        $(".popup-TUT").show();
        $("#startDay").addClass('next-cat-left');
    }, 600);
}

function endTut() {
    $("#startDay").addClass('next-cat-left');
    stepTut = 0;
    $("#tutorial").hide();
    $(".tut-method").hide();
    $("#page-after-tutorial").addClass('next-cat-left');
    setTimeout(function () {
        $("#page-after-tutorial").hide();
        if (startLearn) {
            //zacznij naukę
            showStartLessonPage();
            startLearn = false;
        } else {
            //powrót do głównego
        }
    }, 1000);
}

function startSetNewCategory() {
    logEventInServer('search lesson', {});
    getCatList();
    $("#new-category-choice").addClass('next-cat-left');
    setTimeout(function () {
        if (firstGenerationCat) {
            firstGenerationCat = false;
            activateSearch();
        }
        $("#new-category-choice").hide();
        setTimeout(function () {
            $("#choose-cat").show();
        }, 75);
        setTimeout(function () {
            $("#choose-cat").removeClass('next-cat-right');
        }, 150);
        $("#cats").show();
    }, 700);
}

var firstGenerationCatAllCats = true;

function runList() {
    setTimeout(function () {
        if (firstGenerationCatAllCats) {
            firstGenerationCatAllCats = false;
            activateSearchAllCats();
        }
    }, 700);
}

function closeManualSettingCat() {
    $("#new-category-choice").show();
    $("#choose-cat").addClass('next-cat-right');
    setTimeout(function () {
        $("#new-category-choice").removeClass('next-cat-left');
        $("#choose-cat").hide();
    }, 700);
}

function backToSetNewCategory() {
    $("#choose-cat").addClass('next-cat-right');
    setTimeout(function () {
        $("#choose-cat").hide();
        $("#new-category-choice").show();
        setTimeout(function () {
            $("#new-category-choice").removeClass('next-cat-left');
            $("#learn-container").addClass('next-cat-left');
            $("#progess-btn-stan-in-cycle").addClass('p100');
            $(".progess-btn-stan-in-session").addClass('p100');
            setTimeout(function () {
                loadProgressBarToFull2();
            }, 200);
        }, 50);
    }, 500);
}

function startChoiceNewCategory() {
    if (sugGetIsSetter) {
        $("#suggest-new-category-text").text(suggestedCatName);
        showMuteIcon();
        $('section').hide();
        $("#new-category-choice").show();
        hasNewCatsToday = true;
        setTimeout(function () {
            if ($("#new-category-choice").hasClass('next-cat-right')) {
                $("#new-category-choice").removeClass('next-cat-right');
            } else {
                $("#new-category-choice").removeClass('next-cat-left');
            }
            $("#learn-container").addClass('next-cat-left');
            $(".progess-btn-stan-in-session").addClass('p100');
            $("#progess-btn-stan-in-cycle").addClass('p100');
            setTimeout(function () {
                loadProgressBarToFull2();
            }, 200);
            setPopupAboutNoAudioLesson();
        }, 50);
    } else {
        endTodayLesson = true;
        saveDay();
    }
}

var ix2 = 1;

function loadProgressBarToFull2() {
    ix2 = 1;
    smoothLoadProgressBar2();
}

function smoothLoadProgressBar2() {
    setTimeout(function () {
        $("#progess-btn-stan-in-cycle-ncat").addClass('p' + ix2);
        ix2++;
        if (ix2 < 101) {
            smoothLoadProgressBar2();
        }
    }, 15)
}

function removeAllProgress2() {
    for (var i = 1; i < 102; i++) {
        $("#progess-btn-stan-in-cycle-ncat").removeClass('p' + i);
    }
}

function setSuggestedCat(par, cat) {
    var idLang = $("#myLang").val();
    $.get("date/" + idLang + "/" + par + "/subcat.json", function (result) {
        var scat = JSON.parse(result);
        for (var x in scat) {
            var c = scat[x];
            if (c.id == cat) {
                getCatWithPos(c.pos, 1);
            }
        }
    });
}

var userChoiceCat = false;

function setThisAsSuggestedCat(par, cat) {
    var idLang = $("#myLang").val();
    userChoiceCat = true;
    $.get("date/" + idLang + "/" + par + "/subcat.json", function (result) {
        var scat = JSON.parse(result);
        for (var x in scat) {
            var c = scat[x];
            if (c.id == cat) {
                getCatWithPos(c.pos, 0);
            }
        }
    });
}

function setSuggestedCatName(idp, idc) {
    var idLang = $("#myLang").val();
    $.get("date/" + idLang + "/" + idp + "/subcat.json", function (result) {
        var scat = JSON.parse(result);
        for (var x in scat) {
            var cat = scat[x];
            if (cat.id == idc) {
                getCatWithPos(cat.pos, 1);
            }
        }
    });
}

function setSuggestedCatAsNew() {
    $("#new-category-choice").addClass('next-cat-right');
    setTimeout(function () {
        $("#new-category-choice").hide();
        dayJSONwordsCopy = dayJSON.words;
        dayJSON.words = dayJSON.words + wordsInOneCat;
        var res = suggestedCatPath.split("/");
        var parent = res[0];
        var cat = res[1];
        logEventInServer('start suggested lesson', {day: dayJSON.day, category: parent, subcategory: cat});
        $("#learn-container").addClass('next-cat-left');
        $(".countOfNewWordsToday").text(wordsInOneCat);
        setTimeout(function () {
            setNewCat(parent, cat);
            $("#myCat").val(cat);
            $("#myParentCat").val(parent);
            $("#learn-container").show();
            packControler();
            $("#words-nav").show();
        }, 300);
    }, 500);
}

function showStartLessonPage() {
    gameIsBegin = true;
    $('seciton').hide();
    $("#startDay").show();
    setTimeout(function () {
        $("#startDay").removeClass('next-cat-left');
        setTimeout(function () {
            if (lessonsJumpToFuture > 0) {
                var text = lessonsJumpToFuture + " " + getTrans(t_automated_skipped_lessons);

                window.plugins.toast.showWithOptions(
                    {
                        message: text,
                        duration: "long",
                        position: "bottom"
                    }
                );
            }
        }, 500);
    }, 100);
}

function startLesson() {
    logEventInServer('start learn', {toLearnToday: toLearn});
    packControler();
}

function removeAllProgressClass(obj) {
    return;
}

function removeProgressClassMin(obj, min) {
    for (var i = 100; i > min; i--) {
        obj.removeClass('p' + i);
    }
}

function updateProgressBar() {
    removeAllProgressClass($("#progess-btn-stan-in-cycle"));
    removeAllProgressClass($(".progess-btn-stan-in-cycle-2"));
    removeAllProgressClass($(".progess-btn-stan-in-cycle-3"));
    setTimeout(function () {
        var percent = 100 - Math.round(((learnedWords) / (countWordsToLearn)) * 100);
        var percent2 = 100 - Math.round(((learnedWordsInCat) / (countWordsToLearnInThisCycle)) * 100);
        var percent3 = Math.round(((learnedWordsInCat) / (countWordsToLearnInThisCycle)) * 100);
        var percent4 = Math.round(((learnedWords) / (countWordsToLearn)) * 100);
        $("#progess-btn-stan-in-cycle").addClass('p' + percent4);
        $(".progess-btn-stan-in-session").addClass('p' + percent2);
        $(".progess-btn-stan-in-cycle-2").addClass('p' + percent3);
        $(".progess-btn-stan-in-cycle-3").addClass('p' + percent);
        removeProgressClassMin($("#progess-btn-stan-in-cycle"), percent4);
        removeProgressClassMin($(".progess-btn-stan-in-session"), percent2);
        removeProgressClassMin($(".progess-btn-stan-in-cycle-2"), percent3);
        removeProgressClassMin($(".progess-btn-stan-in-cycle-3"), percent);
        $(".all-words-to-end").text(countWordsToLearn - learnedWords);
        $("#learn-container .all-words-to-end").text(parseInt((learnedWordsInCat) / countWordsToLearnInThisCycle * 100) + "%");
        if ((countWordsToLearn - learnedWords) != (countWordsToLearnInThisCycle - learnedWordsInCat)) {
            $(".all-words-to-end-sesion").text(countWordsToLearnInThisCycle - learnedWordsInCat);
        } else {
            $(".all-words-to-end-sesion").text('');
        }
    }, 50);
}

/*END TUTORIAL*/
var sugGetIsSetter = false;
var scdCycleInSearchSub = false;
var suggestedCatHasAudio = true;

function getCatWithPos(pos, off) {
    $.get("date/" + langJSON.lang + "/cat.json", function (result) {
        var cats = JSON.parse(result);
        var catSize = cats.length;
        for (var x in cats) {
            var cat = cats[x];
            var idP = cat.id;
            $.ajax({
                url: "date/" + langJSON.lang + "/" + idP + "/subcat.json",
                type: 'get',
                dataType: 'html',
                async: false,
                success: function (result) {
                    var scats = JSON.parse(result);
                    var scatSize = scats.length;
                    for (var sc in scats) {
                        var scat = scats[sc];
                        if (parseInt(scat.pos) == (parseInt(pos) + off)) {
                            if (!userChoiceCat && (dayJSON.skiped.indexOf(idP + "/" + scat.id) >= 0 || learnedCat.indexOf(idP + "/" + scat.id) >= 0 || inProgressCat.indexOf(idP + "/" + scat.id) >= 0)) {
                                if ((parseInt(x) + 1) == catSize && (parseInt(sc) + 1) == scatSize) {
                                    if (scdCycleInSearchSub) {
                                        isNotNewCat();
                                        return;
                                    }
                                    else {
                                        scdCycleInSearchSub = true;
                                        getCatWithPos(1, 0);
                                        return;
                                    }
                                }
                                off++;
//
                                getCatWithPos(pos, off++);
                                return;

                            } else {
                                userChoiceCat = false;
                                $("#sugCatPar").val(idP);
                                $("#sugCatSub").val(scat.id);
                                suggestedCatHasAudio = (scat.audio == true || isPayedPro == true);
                                suggestedCatPath = idP + "/" + scat.id;
                                suggestedCatName = scat.name;
                                getWordToSuggestCat(idP + "/" + scat.id);
                                sugGetIsSetter = true;
                                return;
                            }
                        } else if (pos == allCats.length && allCats.length > 0 && parseInt(scat.pos) == pos) {
                            if (scdCycleInSearchSub) {
                                isNotNewCat();
                                return;
                            } else {
                                scdCycleInSearchSub = true;
                                getCatWithPos(1, 0);
                                return;
                            }
                        }
                    }
                }
            });
        }
    });
}

function getAllCatsInArray() {
    $.get("date/" + langJSON.lang + "/cat.json", function (result) {
        var cats = JSON.parse(result);
        for (var x in cats) {
            var cat = cats[x];
            var idP = cat.id;
            $.ajax({
                url: "date/" + langJSON.lang + "/" + idP + "/subcat.json",
                type: 'get',
                dataType: 'html',
                async: false,
                success: function (result) {
                    var scats = JSON.parse(result);
                    for (var sc in scats) {
                        var scat = scats[sc];
                        allCats.push(idP + "/" + scat.id);
                        if(scat.audio == true) {
                            catsWithAudioInDemo.push(idP + "/" + scat.id);
                        }
                    }
                }
            });
        }
    });
}

function isNotNewCat() {
    if (gameIsBegin) {
        suggestedCatHasAudio = -1;
        $("#new-category-choice").addClass('next-cat-right');
        endTodayLesson = true;
        saveDay();
        setTimeout(function () {
            $("#new-category-choice").hide();
            /*
			if(todayEndedCat != "") allEndedCats.push(todayEndedCat);
			uniqueallEndedCats = allEndedCats.filter(function(item, pos) {
				return allEndedCats.indexOf(item) == pos;
			});
			if(allCats.sort().toString() == uniqueallEndedCats.sort().toString() && (inProgressCat.length == 0 || (inProgressCat.length == 1 && inProgressCat[0] == todayEndedCat))){
				$("#new-category-choice").hide();
				$("#end-course").show();
				$(".countKMLearned").text( Math.floor( (dayJSON.km )*minCat / 60) );
				$(".countMinLearned").text( Math.floor( (dayJSON.km )*minCat % 60) );
				setTimeout(function(){
					$("#end-course").removeClass('next-cat-left');
					showRating();
				}, 100);
			}else{

				showEndNewMaterialsInfo();

				$("#new-category-choice").hide();
				$("#end-panel").show();
				setTimeout(function(){
					$("#end-panel").removeClass('next-cat-left');
					showRating();
				}, 100);
			}
			*/
        }, 500);
    }
}

function getNextSugCat() {
    $("#new-category-choice").addClass('next-cat-left');
    setTimeout(function () {
        scdCycleInSearchSub = false;
        var p = $("#sugCatPar").val();
        var c = $("#sugCatSub").val();
        setSuggestedCat(p, c);
        addCatToMissing(p + "/" + c);
        setTimeout(function () {
            $("#suggest-new-category-text").text(suggestedCatName);
            $("#new-category-choice").removeClass('next-cat-left');
            setTimeout(function () {
                setPopupAboutNoAudioLesson();
                showMuteIcon();
            }, 500);
        }, 200);
    }, 700);

    var text = getTrans(t_skipped_lesson_success);
    window.plugins.toast.showWithOptions(
        {
            message: text,
            duration: "short",
            position: "bottom"
        }
    );
}

function addCatToMissing(catSgn) {
    dayJSON.skiped.push(catSgn);
    allEndedCats.push(catSgn);
    allUsedCats.push(catSgn);
}

var agreeToCheckTheUsedCatAsSug = false;

function getThisCatAsSug(obj) {
    if ($(obj).hasClass('missingCat') && !agreeToCheckTheUsedCatAsSug) {
        //pokaż powiadomienie, że zeskipowałeś tą kategorię ale i tak chcesz się jej uczyć
        showConfirmLearnMissingCat(obj);
    } else if (($(obj).hasClass('inProgressCat') || ($(obj).hasClass('learnedCat'))) && !agreeToCheckTheUsedCatAsSug) {
        //pokaż powiadomienie, że już się jej uczysz i czy chcesz zacząć od nowa
        showConfirmLearnInProgressCat(obj);
    } else {
        agreeToCheckTheUsedCatAsSug = false;
        var p = $(obj).attr('data-parent');
        var c = $(obj).attr('data-subcat');
        logEventInServer('choose manual lesson', {day: dayJSON.day, category: p, subcategory: c});
        setThisAsSuggestedCat(p, c);
        setTimeout(function () {
            $("#suggest-new-category-text").text(suggestedCatName);
            showMuteIcon();
            backToSetNewCategory();
            setPopupAboutNoAudioLesson();
        }, 100);
    }
}

/* SAVE PROGRESS */
var progressJSON = [];
var srcSaveProgress = "myProgress.speaklabs";

function saveProgressInFile() {
    var progress = '{"langJSON": "", "dayJSON": "", "toLearnJSON": "", "noticeJSON": "", "likedJSON": ""}';
    progressJSON = JSON.parse(progress);
    progressJSON.langJSON = langJSON;
    progressJSON.dayJSON = dayJSON;
    progressJSON.toLearnJSON = toLearnJSON;
    progressJSON.noticeJSON = noticeJSON;
    progressJSON.likedJSON = likedJSON;
    saveFileProgress();
}

function saveFileProgress() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSNProgress, failN);
}

function gotFSNProgress(fileSystem) {
    fileSystem.root.getFile(srcSaveProgress, {create: true}, gotFileEntryNProgress, failN);
}

function gotFileEntryNProgress(fileEntry) {
    fileEntry.createWriter(gotFileWriterNProgress, failN);
    srcToShare = fileEntry.toURL();
}

function gotFileWriterNProgress(writer) {
    writer.onwrite = function (evt) {
        console.log("write success");
    };

    writer.write(JSON.stringify(progressJSON));
    writer.abort();
}

function failN(error) {

}

/* END SAVE FILE */

/* READ PROGRESS */
var srcLoadProgress = "";

function loadProgress(uri) {
    srcLoadProgress = uri;
    window.FilePath.resolveNativePath(srcLoadProgress, function (localFileUri) {
        window.resolveLocalFileSystemURL(localFileUri, function (oFile) {
            oFile.file(function (readyFile) {
                var reader = new FileReader();
                reader.onloadend = function (evt) {
                    if (IsJsonString(evt.target.result)) {
                        var res = JSON.parse(evt.target.result);
                        langJSON = res.langJSON;
                        dayJSON = res.dayJSON;
                        toLearnJSON = res.toLearnJSON;
                        noticeJSON = res.noticeJSON;
                        likedJSON = res.likedJSON;

                        saveLang(); //save lang
                        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSN, failN); //save notice
                        /*save day*/
                        endTodayLesson = false;
                        datesJSON5 = dayJSON;
                        srcSave5 = path() + "day.json";
                        saveFile5();
                        /*end day*/
                        /*save tolearn*/
                        setTimeout(function () {
                            datesJSON = toLearnJSON;
                            srcSave = path() + "save.json";
                            saveFile();
                        }, 200);
                        /*end tolearn*/
                        /*komunikat i restart*/
                        setTimeout(function () {
                            getTrans(t_import_from_file_success);
                            setTimeout(function () {
                                location.reload();
                            }, 500);
                        }, 500);
                    } else {
                        getTrans(t_import_from_file_error);
                    }
                };
                reader.readAsText(readyFile);
            });
        }, function (err) {
            getTrans(t_import_from_file_error);
        });
    });
}

function IsJsonString(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}

/* END READ FILE */
/* START statistic */
var isInList = [];

function showInProgressCat() {
    for (var p in inProgressCat) {
        var res = inProgressCat[p].split("/");
        var idp = res[0];
        var idc = res[1];
        setinProgressCatList(idp, idc);
    }
}

function setinProgressCatList(idp, idc) {
    if (!(isInList.indexOf(idp + "/" + idc) >= 0)) {
        isInList.push(idp + "/" + idc);
        var idLang = $("#myLang").val();
        $.get("date/" + idLang + "/" + idp + "/subcat.json", function (result) {
            var scat = JSON.parse(result);
            for (var x in scat) {
                var cat = scat[x];
                if (cat.id == idc) {
                    $(".catNameInListWord").text(cat.name);
                    $(".inProgressCatList").append('<p class="text" onclick="showMeWordInThisCat(' + idp + ', ' + idc + ', \'' + cat.name + '\')">' + cat.name + '</p>');
                }
            }
        });
    }
}

function showMeWordInThisCat(idp, idc, name) {
    $(".catNameInListWord").text(name);
    fillTableListWordInCatMain(idp, idc);
    //fillTableListWordInCat(idp, idc);
    //fillTableListWordInCatWithNote(idp, idc);
    $("#list-of-word-in-cat").show();
    setTimeout(function () {
        $("#list-of-word-in-cat").removeClass('goLeft');
    }, 300);
}

function fillTableListWordInCatMain(idp, idc) {
    var sygn = idp + "/" + idc;
    var i = 1;

    $.get("date/" + langJSON.lang + "/" + sygn + "/words.json", function (result) {
        $("#listWordOfCatInInPorgress").text("");
        $.get("date/1/" + sygn + "/words.json", function (transResult) {
            var words = JSON.parse(result);
            var trans = JSON.parse(transResult);
            for (var x in words) {
                var w = words[x];
                var t = trans[x];
                var linkwordwrap = "";
                var hasLinkword = false;
                for (var z in noticeJSON) {
                    var notice = noticeJSON[z];
                    var tmp = langJSON.lang + "\\" + idp + "\\" + idc + "\\" + 1 + "\\" + (parseInt(x) + 1);
                    if (notice.word == tmp) {
                        linkwordwrap = "<br><strong>Linkword:</strong> " + notice.notice;
                        $("#listWordOfCatInInPorgress").append('<p class="text" onclick="tellMeWord(\'' + sygn + '\',' + w.id + ')">' + i + '. ' + t.name + '<span>' + w.name + linkwordwrap + '</span></p>');
                        hasLinkword = true;
                    }
                    if (!hasLinkword && z == (noticeJSON.length - 1)) {
                        $("#listWordOfCatInInPorgress").append('<p class="text" onclick="tellMeWord(\'' + sygn + '\',' + w.id + ')">' + i + '. ' + t.name + '<span>' + w.name + '</span></p>');
                    }
                }
                if (noticeJSON.length == 0) {
                    $("#listWordOfCatInInPorgress").append('<p class="text" onclick="tellMeWord(\'' + sygn + '\',' + w.id + ')">' + i + '. ' + t.name + '<span>' + w.name + '</span></p>');
                }
                i++;
            }
        });
    });
}

function fillTableListWordInCat(idp, idc) {
    var idLang = $("#myLang").val();
    var i = 1;
    $.get("date/" + idLang + "/" + idp + "/" + idc + "/words.json", function (result) {
        var words = JSON.parse(result);
        for (var x in words) {
            var w = words[x];
            $(".t" + i).html(w.name);
            i++;
        }
    });
}

function fillTableListWordInCatWithNote(idp, idc) {
    var idLang = $("#myLang").val();
    var i = 1;
    for (i = 1; i < 11; i++) {
        $(".n" + i).html("");
        for (var x in noticeJSON) {
            var notice = noticeJSON[x];
            var tmp = idLang + "\\" + idp + "\\" + idc + "\\" + 1 + "\\" + i;
            if (notice.word == tmp) {
                $(".n" + i).html("(" + notice.notice + ")");
            }
        }
    }
}

/* END statistic */
function checkConnection() {
    return (!(navigator.connection.type == 0 || navigator.connection.type == 'none'));
}

function showRating() {
    if (isPremium) {
        AppRate.preferences = {
            displayAppName: getTrans(t_app_name_pro),
            storeAppURL: {
                android: 'market://details?id=com.speaklabs.english.speaklabsPro'
            },
            useLanguage: getTrans(t_lang_rank),
            simpleMode: true,
            callbacks: {
                onButtonClicked: function (buttonIndex) {
                    if (buttonIndex == 1) {
                        setRatingToTrue();
                    }
                }
            }
        };
    } else {
        AppRate.preferences = {
            displayAppName: getTrans(t_app_name),
            storeAppURL: {
                android: 'market://details?id=com.speaklabs.english.speaklabs'
            },
            useLanguage: getTrans(t_lang_rank),
            simpleMode: true,
            callbacks: {
                onButtonClicked: function (buttonIndex) {
                    if (buttonIndex == 1) {
                        setRatingToTrue();
                    }
                }
            }
        };
    }

    var day = parseInt($("#nrDayFiled").text());
    if (day % 2 == 0 && day > 0 && dayJSON.rating == false) {
        if (isPremium) {
            AppRate.promptForRating();
        }
    }
}

function setRatingToTrue() {
    endTodayLesson = false;
    dayJSON.rating = true;
    datesJSON5 = dayJSON;
    srcSave5 = path() + "day.json";
    saveFile5();
}

function saveTheme() {
    endTodayLesson = false;
    var themeNb = 1;
    if ($("body").hasClass('theme3')) {
        var themeNb = 3;
    } else if ($("body").hasClass('theme2')) {
        var themeNb = 2;
    } else {
        var themeNb = 1;
    }
    logEventInServer('change theme', mergeObjects({theme: themeNb}, getDataAboutCurrentWordToLog()));
    dayJSON.theme = themeNb;
    datesJSON5 = dayJSON;
    srcSave5 = path() + "day.json";
    saveFile5();
}

function setTextWidth() {
    $(".text").css('min-width', $(window).width() * 0.85);
}

var srcToShare = "";

function shareFile() {
    var optionsToShare = {
        message: 'Save progress', // not supported on some apps (Facebook, Instagram)
        subject: 'My progress', // fi. for email
        files: [srcToShare], // an array of filenames either locally or remotely
        url: null,
        chooserTitle: 'Save progress' // Android only, you can override the default share sheet title
    }

    var onSuccessShare = function (result) {
        console.log("Share completed? " + result.completed); // On Android apps mostly return false even while it's true
        console.log("Shared to app: " + result.app); // On Android result.app is currently empty. On iOS it's empty when sharing is cancelled (result.completed=false)
    }

    var onErrorShare = function (msg) {
        console.log("Sharing failed with message: " + msg);
    }

    window.plugins.socialsharing.shareWithOptions(optionsToShare, onSuccessShare, onErrorShare);
}

function volumeTest() {
    //podgłośnienie
    /*window.plugin.volume.getVolume(function(volume) {
		if(volume < 0.20){
			showVolumeInfo();
		}
	});*/
}

function showVolumeInfo() {
    navigator.notification.confirm(
        "Turn up the volume to hear the sound",
        okNoSound,
        "Warning!",
        "OK"
    );
}

function okNoSound() {
    return true;
}

function getAllCatsToShowAllCats() {
    $("#show-all-cats-cats").html('');
    $.get("date/" + langJSON.lang + "/cat.json", function (result) {
        var tmp = '';
        var cats = JSON.parse(result);
        for (var x in cats) {
            subcats = false;
            var cat = cats[x];
            //if(x == 0) tmp += '<div><h1 class="text superbigcat-all-material" onclick="expand(this);"><span class="l2">E_Fiszki</span><span class="l3">F_Fiszki</span><span class="l4">N_Fiszki</span><span class="l5">Phrases</span></h1><div>';
            //if(x == countCatInFirstBigCat) tmp += '</div></div><div><h1 class="text superbigcat-all-material" onclick="expand(this);"><span class="l2">E_Gramatyka</span><span class="l3">F_Gramatyka</span><span class="l4">N_Gramatyka</span><span class="l5">Gramatyka</span></h1><div>';
            tmp += '<div><h1 class="text supercat-all-material" onclick="expand(this);">' + cat.name + '</h1>';
            var extraEnd = parseInt(x) + 1 == parseInt(cats.length) ? '</div></div>' : "";

            $.ajax({
                url: "date/" + langJSON.lang + "/" + cat.id + "/subcat.json",
                type: 'get',
                dataType: 'html',
                async: false,
                success: function (data) {
                    var subcats = JSON.parse(data);
                    tmp += '<div class="list-of-subcat-all-material">';
                    for (var y in subcats) {
                        var subcat = subcats[y];
                        var catSgn = cat.id + "/" + subcat.id;
                        var cl = "";
                        if (dayJSON.skiped.indexOf(catSgn) >= 0) {
                            cl = "missingCat";
                        }
                        if (learnedCat.indexOf(catSgn) >= 0) {
                            cl = "learnedCat";
                        }
                        if (inProgressCat.indexOf(catSgn) >= 0) {
                            cl = "inProgressCat";
                        }
                        cl2 = (subcat.audio == true || isPayedPro == true) ? '' : 'no-audio';
                        hasAudio = (subcat.audio == true || isPayedPro == true) ? 1 : 0;
                        tmp += '<p class="text catsInAllMaterial ' + cl + ' ' + cl2 + '" onclick="setCatToViewWords(\'' + catSgn + '\', \'' + subcat.name + '\', ' + hasAudio + ')" data-parent="' + cat.id + '" data-subcat="' + subcat.id + '"><strong>' + (subcat.name).substring(0, 2) + '</strong> ' + (subcat.name).substring(2) + '<span class="inProgressCatInfo">' + getTrans(t_during_learning) + '</span> <span class="missingCatInfo">' + getTrans(t_lesson_skipped) + '</span> <span class="learnedCatInfo">' + getTrans(t_learned_lesson) + '</span></p>';
                        $("#show-all-cats-cat-list .list").append('<li><p class="cat-name-all-material" data-id="' + subcat.id + '" data-par="' + cat.id + '">' + subcat.name + '</p></li>');
                    }
                    //tmp += '</div>' + '</div>' + extraEnd;
                    tmp += '</div>' + '</div>';
                }
            });
        }

        $("#show-all-cats-cats").append(tmp);
    });
}

function getWordForCatShowList(sygn, hasAudio) {
    var splitedWordSygn = sygn.split('/');
    $.get("date/" + langJSON.lang + "/" + sygn + "/words.json", function (result) {
        $("#show-all-cats-cats-wordlist").text("");
        $.get("date/1/" + sygn + "/words.json", function (transResult) {
            var words = JSON.parse(result);
            var trans = JSON.parse(transResult);
            for (var x in words) {
                var w = words[x];
                var t = trans[x];
                var audio_icon = hasAudio ? 'img/spiker_white.png' : 'img/spiker_no_audio_white.png';
                $("#show-all-cats-cats-wordlist").append('<p class="text" data-source="all-words" data-category="'+ splitedWordSygn[0] +'" data-subcategory="'+ splitedWordSygn[1] +'" data-word="'+ w.id +'" onclick="tellMeWordFrom(\'' + sygn + '\',' + w.id + ', this)"><img src="' + audio_icon + '" class="left-img">' + t.name + '<span class="small-text-in-text-box">' + w.name + '</span><img src="img/mic_icon.png" ontouchstart="checkMeWord(\'' + (t.name).replace(/(['"])/g, "\\$1") + '\', this); return false;"></p>');
            }
        });
    });
}

var countOfWrongRecognized = 0;

function startVoiceToText() {
    if (dev) {
        $(".recText").text("To powiedziałem");
        $("#l-n-1").hide();
        $("#l-n-2").hide();
        $("#l-n-3").hide();
        $("#l-n-4").hide();
        $("#l-n-5").hide();
        $("#l-n-6").hide();

        $("#l-e-1").hide();
        $("#l-e-2").hide();
        $("#l-e-3").hide();
        $("#l-e-4").hide();
        $("#l-e-5").hide();
        $("#l-e-6").hide();

        $("#l-t-1").hide();
        $("#l-t-2").hide();
        $("#l-t-3").hide();
        $("#l-t-4").hide();
        $("#l-t-5").hide();
        $("#l-t-6").hide();

        $("#l-c-1").show();
        $("#l-c-2").show();
        $("#l-c-3").show();
        $("#l-c-4").show();
        $("#l-c-5").show();
        $("#l-c-6").show();

        $(".recTextWrap").show();
        $(".recText").show();

        $(".show-hidden-word").next("p").show();
        $(".show-hidden-word").hide();

        if (((Math.random() * 10) + 1) > 5) {
            $(".learnMethod").addClass('goodRec');
            $(".learnMethod").removeClass('badRec');
            $(".cloud-again").hide();
            $(".cloud-next-task").hide();
            setTimeout(function () {
                isOkWrap();
            }, 500);
        } else {
            $(".learnMethod").removeClass('goodRec');
            $(".learnMethod").addClass('badRec');
            $(".cloud-again").show();
            $(".cloud-next-task").show();
            $(".remind-img").hide();
        }
    }

    if (!checkConnection()) {
        navigator.notification.confirm(
            getTrans(t_not_connected_text),
            onNoInternetConfirm,
            getTrans(t_not_connected_title),
            getTrans(t_not_connected_exit)
        );
    } else {
        checkPermissionsAndStartRecognize();
    }

    setTimeout(function () {
        $("#progess-btn-stan-in-cycle").removeClass('hover-progres-round');
    }, 150);

}

function checkPermissionsAndStartRecognize() {
    if(blockAppIfNotLegal() === false) {
        logEventInServer('start speach recognize in lesson', getDataAboutCurrentWordToLog());

        window.plugins.speechRecognition.hasPermission(
            function (hasPermission) {
                if(hasPermission === false) {
                    window.plugins.speechRecognition.requestPermission(startRecognize);
                } else {
                    startRecognize();
                }
            }
        );
    }
}

function startRecognize() {
    stopTelling();

    var langText = "en-GB";
    var options = {
        language: langText,
        matches: 2,
        prompt: ((nbMethod == 6 || nbMethod == 5 || (nbMethod == 4 && nbStep == 0 && $("#nav-words-container p.activ").index() == 9)) ? clearTextToShowOnRecognize(act_trans) : clearTextToShowOnRecognize(act_word)),
        showPopup: true
    };

    window.plugins.speechRecognition.startListening(
        function (matches) {
            if (matches[0] != '') {
                var text = matches[0];
                $(".recText").text(text);

                $("#l-n-1").hide();
                $("#l-n-2").hide();
                $("#l-n-3").hide();
                $("#l-n-4").hide();
                $("#l-n-5").hide();
                $("#l-n-6").hide();

                $("#l-e-1").hide();
                $("#l-e-2").hide();
                $("#l-e-3").hide();
                $("#l-e-4").hide();
                $("#l-e-5").hide();
                $("#l-e-6").hide();

                $("#l-t-1").hide();
                $("#l-t-2").hide();
                $("#l-t-3").hide();
                $("#l-t-4").hide();
                $("#l-t-5").hide();
                $("#l-t-6").hide();

                $("#l-c-1").show();
                $("#l-c-2").show();
                $("#l-c-3").show();
                $("#l-c-4").show();
                $("#l-c-5").show();
                $("#l-c-6").show();

                $(".recTextWrap").show();
                $(".recText").show();

                $(".show-hidden-word").next("p").show();
                $(".show-hidden-word").hide();

                compareRecognizedText(text);
                $(".support-word-in-speach").hide();
            }
        },
        function () {
            $(".support-word-in-speach").hide();
        },
        options
    );
}

function compareRecognizedText(text) {
    var correctText = clearTextToShowOnRecognize($(".learnMethod:visible .text-trans-word").text());
    if (text.toLowerCase().replace(/[^a-zA-Z0-9]/g, '') == correctText.toLowerCase().replace(/[^a-zA-Z0-9]/g, '')) {
        logEventInServer('good speach in lesson', mergeObjects({spokenText: text}, getDataAboutCurrentWordToLog()));
        countOfWrongRecognized = 0;
        $(".learnMethod").addClass('goodRec');
        $(".learnMethod").removeClass('badRec');
        $(".cloud-again").hide();
        $(".cloud-next-task").hide();
        setTimeout(function () {
            isOkWrap();
        }, 500);
    } else {
        logEventInServer('bad speach in lesson', mergeObjects({spokenText: text}, getDataAboutCurrentWordToLog()));
        $(".learnMethod").removeClass('goodRec');
        $(".learnMethod").addClass('badRec');
        $(".cloud-again").show();
        $(".cloud-next-task").show();
        $(".remind-img").hide();
        countOfWrongRecognized++;
        if (countOfWrongRecognized == 1) {
            tellMe();
        }
        if (countOfWrongRecognized == 2) {
            showRecognizedAlert();
        }
        if (countOfWrongRecognized == 3) {
            countOfWrongRecognized = 0;
            showRecognizedAlert3();
        }
    }
}

function showRecognizedAlert() {
    navigator.notification.confirm(
        getTrans(t_recognize_error_first_text),
        showRecognizedAlertCallback,
        getTrans(t_recognize_error_title),
        getTrans(t_recognize_error_try_again) + "," + getTrans(t_recognize_error_skip)
    );
}

function showRecognizedAlert2() {
    navigator.notification.confirm(
        getTrans(t_recognize_error_second_text),
        showRecognizedAlertCallback,
        getTrans(t_recognize_error_title),
        getTrans(t_recognize_error_try_again) + "," + getTrans(t_recognize_error_skip)
    );
}

function showRecognizedAlert3() {
    navigator.notification.confirm(
        getTrans(t_recognize_error_third_text),
        showRecognizedAlertCallback,
        getTrans(t_recognize_error_title),
        getTrans(t_recognize_error_try_again) + "," + getTrans(t_recognize_error_skip)
    );
}

function showRecognizedAlertCallback(buttonIndex) {
    if (buttonIndex == 1) {
        startVoiceToText();
    }
    if (buttonIndex == 2) {
        logEventInServer('skip word', mergeObjects({source: 'wrong speach recognize'}, getDataAboutCurrentWordToLog()));
        isOkWrap();
    }
}

//the function
function renameFile(currentName, currentDir, newName, successFunction) {

    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fileSystem) {

        fileSystem.root.getFile(currentDir + currentName, null, function (fileEntry) {
            fileSystem.root.getDirectory(currentDir, {create: true}, function (dirEntry) {
                parentEntry = new DirectoryEntry(currentName, currentDir + currentName);

                fileEntry.moveTo(dirEntry, newName, function () {

                    successFunction();

                }, renameFail);
            }, renameFail);
        }, renameFail);

    }, renameFail);
}

//and the sample success function
function renameSuccess() {

}

//and the sample fail function
function renameFail() {

}

function showConfirmSkipRepetition() {
    navigator.notification.confirm(
        getTrans(t_confirm_skip_lesson_text),
        showConfirmSkipRepetitionCallBack,
        getTrans(t_confirm_skip_lesson_title),
        getTrans(t_confirm_skip_lesson_skip) + "," + getTrans(t_confirm_skip_lesson_cancel)
    );
}

function showConfirmSkipRepetitionCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        skipRepetition();
    }
    if (buttonIndex == 2) {
        return true;
    }
}

function skipRepetition() {
    logEventInServer('skip repetition', {day: dayJSON.day, category: $("#myParentCat").val(), subcategory: $("#myCat").val()});
    $("#start-next-cat").addClass('next-cat-left');
    $("#learn-container").hide();
    isRepeatCycle = false;
    learnetCatToday++;
    var endThis = false;
    for (var i = 0; i < 10 && !endThis; i++) {
        if (toLearn[i] != -1) {
            endThis = true;
            toLearn[i] = -1;
        }
    }
    $("#learn-container").hide();
    learnedWords += 30;
    setTimeout(function () {
        $("#start-next-cat").hide();
        updateProgressBar();
        packControler();
    }, 500);
}

function showEndNewMaterialsInfo() {
    if (hasNewCatsToday) {
        navigator.notification.confirm(
            getTrans(t_end_new_materials_text),
            showEndNewMaterialsInfoCallback,
            getTrans(t_end_new_materials_title),
            getTrans(t_end_new_materials_ok)
        );
    }
}

function showEndNewMaterialsInfoCallback(buttonIndex) {
    return 1;
}

function returnInLearn() {
    $("#learn-container").addClass('next-cat-left');
    setTimeout(function () {
        $("#learn-container").hide();
    }, 500);

    isRepeatCycle = false;
    newCategoryisSet = false;
    toLearn = copyOfLearnArray.slice();
    inProgressCat = inProgressCatcopyForBackBTN.slice();
    toLearnJSON = JSON.parse(JSON.stringify(toLearnJSONcopyForBackBTN));
    dayJSON.words = dayJSONwordsCopy;
    learnedWords = learnedWordsCopy;
    learnetCatToday = learnetCatTodayCopytBTN;
    updateProgressBar();
    logEventInServer('return while learning', mergeObjects({inNewLesson: isOnlyNewLessonToEndDay(toLearn)}, getDataAboutCurrentWordToLog()));
    nextPack();
}

function hideSpeachClouds() {
    $(".cloud-perfect-all-words").hide();
    $(".cloud-you-said-all-words").hide();
}

var checkingWordWrapper;

function checkMeWord(word_text, obj) {
    checkingWordWrapper = $(obj);
    stopTelling();
    $("#savedWordsContainer p").removeClass('good-telling-word');
    $("#savedWordsContainer p").removeClass('bad-telling-word');
    $("#show-all-cats-cats-wordlist p").removeClass('good-telling-word');
    $("#show-all-cats-cats-wordlist p").removeClass('bad-telling-word');
    returnOriginTextAfterSpeachRecognize();

    if (dev) {
        if (((Math.random() * 10) + 1) > 5) {
            checkingWordWrapper.closest('.text').addClass('good-telling-word');
        } else {
            checkingWordWrapper.closest('.text').addClass('bad-telling-word');
            var $bottomText = checkingWordWrapper.closest('.text').find('.small-text-in-text-box');
            $bottomText
                .addClass('wrong-speach-text')
                .attr('data-origin-text', $bottomText.html())
                .html('błędnie powiedziany text');
        }
    }

    checkPermissionsAndStartRecognizeInAllWords(word_text);

}

function checkPermissionsAndStartRecognizeInAllWords(correct_text) {
    if(blockAppIfNotLegal() === false) {
        var $textContainer = checkingWordWrapper.closest('.text');
        var eventName = $textContainer.attr('data-source') == 'liked-word' ? 'start speach recognize in liked' : 'start speach recognize in browsing phrase';
        logEventInServer(eventName, {category: $textContainer.attr('data-category'), subcategory: $textContainer.attr('data-subcategory'), word: $textContainer.attr('data-word')});

        window.plugins.speechRecognition.hasPermission(
            function (hasPermission) {
                if(hasPermission === false) {
                    window.plugins.speechRecognition.requestPermission(function() {
                        startRecognizeInAllWords(correct_text);
                    });
                } else {
                    startRecognizeInAllWords(correct_text);
                }
            }
        );
    }
}

function startRecognizeInAllWords(correct_text) {
    var langText = "en-GB"
    var options = {
        language: langText,
        matches: 2,
        prompt: clearTextToShowOnRecognize(correct_text),
        showPopup: true
    };

    window.plugins.speechRecognition.startListening(
        function (matches) {
            if (matches[0] != '') {
                var text = matches[0];
                compareRecognizedTextInAllWords(text, correct_text);
            }
        },
        function () {

        },
        options
    );
}

function compareRecognizedTextInAllWords(text, correctText) {
    var $textContainer = checkingWordWrapper.closest('.text');
    var wordData = {category: $textContainer.attr('data-category'), subcategory: $textContainer.attr('data-subcategory'), word: $textContainer.attr('data-word')};

    if (text.toLowerCase().replace(/[^a-zA-Z0-9]/g, '') == clearTextToShowOnRecognize(correctText).toLowerCase().replace(/[^a-zA-Z0-9]/g, '')) {
        var eventName = $textContainer.attr('data-source') == 'liked-word' ? 'good speach in liked' : 'good speach in browsing phrases';
        logEventInServer(eventName, mergeObjects({spokenText: text}, wordData));
        checkingWordWrapper.closest('.text').addClass('good-telling-word');
    } else {
        var eventName = $textContainer.attr('data-source') == 'liked-word' ? 'bad speach in liked' : 'bad speach in browsing phrases';
        logEventInServer(eventName, mergeObjects({spokenText: text}, wordData));
        checkingWordWrapper.closest('.text').addClass('bad-telling-word');
        var $bottomText = checkingWordWrapper.closest('.text').find('.small-text-in-text-box');
        $bottomText
            .addClass('wrong-speach-text')
            .attr('data-origin-text', $bottomText.html())
            .html(text);
    }
}

function returnOriginTextAfterSpeachRecognize()
{
    $('.wrong-speach-text').each(function () {
        $(this).html($(this).attr('data-origin-text'));
        // $(this).removeChild('wrong-speach-text');
    });
}

/* LIKED WORDS */
function changeLiked(word_sygn) {
    if (isLikedWord(word_sygn)) {
        removeFromlikedJSON(word_sygn);
        saveLikedWords();
    } else {
        addToLikedJSON(word_sygn);
        saveLikedWords();
    }
}

function removeFromlikedJSON(word_sygn) {
    window.plugins.toast.showWithOptions(
        {
            message: getTrans(t_liked_words_remove),
            duration: "short",
            position: "bottom"
        }
    );
    for (var i in likedJSON) {
        if (likedJSON[i] == word_sygn) {
            likedJSON.splice(i, 1);
            break;
        }
    }

    var splitedWordSygn = word_sygn.split('\\');
    logEventInServer('remove word from liked', {day: dayJSON.day, category: splitedWordSygn[0], subcategory: splitedWordSygn[1], word: splitedWordSygn[2]});
}

function addToLikedJSON(word_sygn) {
    window.plugins.toast.showWithOptions(
        {
            message: getTrans(t_liked_words_added),
            duration: "short",
            position: "bottom"
        }
    );
    likedJSON.push(word_sygn);

    var splitedWordSygn = word_sygn.split('\\');
    logEventInServer('add word to liked', {day: dayJSON.day, category: splitedWordSygn[0], subcategory: splitedWordSygn[1], word: splitedWordSygn[2]});
}

function setActuLikedIcon() {
    if (isLikedWord(getPathToActuWord())) {
        $(".star-liked").attr('src', 'img/star_check.png');
    } else {
        $(".star-liked").attr('src', 'img/star.png');
    }
}

function isLikedWord(word_sygn) {
    if (likedJSON.length == 0) {
        return false;
    }
    for (var x in likedJSON) {
        var word = likedJSON[x];
        if (word == word_sygn) {
            return true;
        }
        if (x == likedJSON.length - 1) {
            return false;
        }
    }
}

function getPathToActuWord() {
    var idParentCat = $("#myParentCat").val();
    var idSubCat = $("#myCat").val();
    var id = $('#idWord').val();
    return (idParentCat + "\\" + idSubCat + "\\" + id);
}

//reading
function readLikedWords() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFSSuccessLiked, onFSError);
}

function onFSSuccessLiked(fileSystem) {
    fileSystem.root.getFile((path() + "liked.json"), {create: false, exclusive: false}, gotFileEntryLiked, onFSError);
}

function gotFileEntryLiked(fileEntry) {
    fileEntry.file(gotFileLiked, onFSError);
}

function gotFileLiked(file) {
    readAsTextLiked(file);
}

function readAsTextLiked(file) {
    var reader = new FileReader();
    reader.onloadend = function (e) {
        afterReadLikedWords(e.target.result);
    };
    reader.readAsText(file);
}

function afterReadLikedWords(res) {
    likedJSON = JSON.parse(res); //PARSOWANIE JSON!!!
}

//saving
function saveLikedWords() {
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSLiked, failN);
}

function gotFSLiked(fileSystem) {
    fileSystem.root.getFile((path() + "liked.json"), {create: true}, gotFileEntryLikedW, failN);
}

function gotFileEntryLikedW(fileEntry) {
    fileEntry.createWriter(gotFileWriterLiked, failN);
}

function gotFileWriterLiked(writer) {
    writer.onwriteend = function (e) {
        afterSaveLikedWords();
    };

    writer.write(JSON.stringify(likedJSON));
    writer.abort();
}

function afterSaveLikedWords() {
    //coś po zapisaniu liked
}

function showSavedWords() {
    $("#savedWordsContainer").text("");
    for (var x in likedJSON) {
        var word = likedJSON[x].split("\\");
        showSavedWord(word);
    }
}

function showSavedWord(word) {
    $.get("date/" + langJSON.lang + "/" + word[0] + "/" + word[1] + "/words.json", function (result) {
        $.get("date/1/" + word[0] + "/" + word[1] + "/words.json", function (transResult) {
            var words = JSON.parse(result);
            var trans = JSON.parse(transResult);
            var w = words[word[2] - 1];
            var t = trans[word[2] - 1];
            $("#savedWordsContainer").append('<p class="text" data-source="liked-word" data-category="'+ word[0] +'" data-subcategory="'+ word[1] +'" data-word="'+ word[2] +'" onclick="tellMeWordFrom(\'' + word[0] + "/" + word[1] + '\',' + w.id + ', this)"><img src="img/star_check.png" class="left-img" onclick="confirmRemoveSavedWord(this, \'' + word[0] + "/" + word[1] + "/" + word[2] + '\',' + w.id + ')">' + t.name + '<span class="small-text-in-text-box">' + w.name + '</span><img src="img/mic_icon.png" ontouchstart="checkMeWord(\'' + (t.name).replace(/(['"])/g, "\\$1") + '\', this); return false;"></p>');
        });
    });
}

var wordToRemoveFromSaved;
var objWordToRemoveFromSaved;

function confirmRemoveSavedWord(obj, word) {
    objWordToRemoveFromSaved = obj;
    wordToRemoveFromSaved = word.replace(/\//g, '\\');

    navigator.notification.confirm(
        getTrans(t_confirm_remove_saved_word_text),
        confirmRemoveSavedWordCallBack,
        getTrans(t_confirm_remove_saved_word_title),
        getTrans(t_confirm_remove_saved_word_remove) + "," + getTrans(t_confirm_remove_saved_word_cancel)
    );
}

function confirmRemoveSavedWordCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        removeFromSavedWords(objWordToRemoveFromSaved, wordToRemoveFromSaved);
        setActuLikedIcon();
    }
    if (buttonIndex == 2) {
        return true;
    }
}

function removeFromSavedWords(obj, word) {
    $(obj).parent().remove();
    removeFromlikedJSON(word);
    saveLikedWords();
}

/* END LIKED WORDS */

function setPopupAboutNoAudioLesson() {
    if (suggestedCatHasAudio == false && isPayedPro == false) {
        navigator.notification.confirm(
            getTrans(t_no_audio_lesson_text),
            setPopupAboutNoAudioLessonBTNCallBack,
            getTrans(t_no_audio_lesson_title),
            getTrans(t_no_audio_lesson_learn_anyway) + "," + getTrans(t_no_audio_lesson_upgrade) + "," + getTrans(t_no_audio_lesson_skip)
        );
    }
}

function setPopupAboutNoAudioLessonInPhraseBrowser() {
    navigator.notification.confirm(
        getTrans(t_no_audio_lesson_text),
        setPopupAboutNoAudioLessonBTNCallBack,
        getTrans(t_no_audio_lesson_title),
        getTrans(t_no_audio_lesson_learn_anyway) + "," + getTrans(t_no_audio_lesson_upgrade)
    );
}

function setPopupAboutNoAudioLessonBTNCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        return true;
    }
    if (buttonIndex == 2) {
        goToPremiumVersion();
    }
    if (buttonIndex == 3) {
        showConfirmSkipLesson();
    }
}

function showMuteIcon() {
    if (suggestedCatHasAudio == false && isPayedPro == false) {
        $("#suggest-new-category").addClass('no-audio-name');
    } else {
        $("#suggest-new-category").removeClass('no-audio-name');
    }
}

function showConfirmBackAlert() {
    navigator.notification.confirm(
        getTrans(t_confirm_back_in_learn_text),
        showConfirmBackAlertCallBack,
        getTrans(t_confirm_back_in_learn_title),
        getTrans(t_confirm_back_in_learn_back) + "," + getTrans(t_confirm_back_in_learn_cancel)
    );
}

function showConfirmBackAlertCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        returnInLearn();
    }
    if (buttonIndex == 2) {
        return true;
    }
}

/* CONFIRM LEARN THE SAME CATEGORY */
var theSameSugCatObjTMP;

function showConfirmLearnMissingCat(obj) {
    theSameSugCatObjTMP = obj;
    navigator.notification.confirm(
        getTrans(t_confirm_learn_missing_cat_text),
        showConfirmLearnMissingCatCallBack,
        getTrans(t_confirm_learn_missing_cat_title),
        getTrans(t_confirm_learn_missing_cat_yes) + "," + getTrans(t_confirm_learn_missing_cat_cancel)
    );
}

function showConfirmLearnMissingCatCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        agreeToCheckTheUsedCatAsSug = true;
        getThisCatAsSug(theSameSugCatObjTMP);
    }
    if (buttonIndex == 2) {
        theSameSugCatObjTMP = false;
        return true;
    }
}

function showConfirmLearnInProgressCat(obj) {
    theSameSugCatObjTMP = obj;
    navigator.notification.confirm(
        getTrans(t_confirm_learn_inprogress_cat_text),
        showConfirmLearnInProgressCatCallBack,
        getTrans(t_confirm_learn_inprogress_cat_title),
        getTrans(t_confirm_learn_inprogress_cat_yes) + "," + getTrans(t_confirm_learn_inprogress_cat_cancel)
    );
}

function showConfirmLearnInProgressCatCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        agreeToCheckTheUsedCatAsSug = true;
        getThisCatAsSug(theSameSugCatObjTMP);
    }
    if (buttonIndex == 2) {
        theSameSugCatObjTMP = false;
        return true;
    }
}

/* SKIP LESSON CONFIRM */
function showConfirmSkipLesson() {
    logEventInServer('skip lesson', {day: dayJSON.day, category: $("#sugCatPar").val(), subcategory: $("#sugCatSub").val()});
    getNextSugCat();
}

function showConfirmSkipLessonCallBack(buttonIndex) {
    if (buttonIndex == 1) {
        getNextSugCat();
    }
    if (buttonIndex == 2) {
        return true;
    }
}

/* exit app */
function showExitAppConfirm() {
    navigator.notification.confirm(
        getTrans(t_confirm_exit_text),
        showExitAppConfirmCallBack,
        getTrans(t_confirm_exit_title),
        getTrans(t_confirm_exit_cancel) + "," + getTrans(t_confirm_exit_exit)
    );
}

function showExitAppConfirmCallBack(button) {
    if (button == 2) {
        navigator.app.exitApp();
    }
}

function updatePlaceholders() {
    $(".fuzzy-search").attr("placeholder", getTrans(t_placeholder_fuzzy_search));
    $(".noteTEXT").attr("placeholder", getTrans(t_placeholder_hint_text));
}

function clearTextToShowOnRecognize(text) {
    return text.replace('<b>', '').replace('</b>', '');
}

function testLegalAppAndRunIfIsLegal(callbackAfterValid) {
    if(legalValidation === true) {
        logEventInServer('request for verify app', {});
        AndroidLicensePlugin.check(
            function (data) {
                var verifiData = data;
                verifiData.packageName = getPackageName();
                var url = getVerifiApiUrl();
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "application/json",
                    data: JSON.stringify(verifiData)
                }).done(function (data) {
                    if(data === true) {
                        startAppBecauseIsLegal(callbackAfterValid);
                    } else {
                        blockAppBecauseNotLegal();
                    }
                }).fail(function (a, b, c) {
                    //coś nie tak z serwerem -> musimy wpuścić do apki
                    startAppBecauseIsLegal(callbackAfterValid);
                });
            },
            function (errorString) {
                //coś nie tak z pluginem -> musimy wpuścic do apki
                startAppBecauseIsLegal(callbackAfterValid);
            }
        );
    } else {
        startAppBecauseIsLegal(callbackAfterValid);
    }
}

function getPackageName() {
    return isPremium ? "com.speaklabs.english.speaklabsPro" : "com.speaklabs.english.speaklabs";
}

function getVerifiApiUrl() {
    return 'http://api.speaklabs.eu/api/verification_licences';
}

function getVerifiPurchaseApiUrl() {
    return 'http://api.speaklabs.eu/api/verification_purchases';
}

function blockAppBecauseNotLegal() {
    isLegal = false;

    logEventInServer('bad verify app', {});
    $('section').hide();
    $('#menu-switch').hide();
    $('#menu').hide();
    setTimeout(function () {
        $('#illegal-app-page').show();
    }, 50);
}

function startAppBecauseIsLegal(callbackAfterValid) {
    isLegal = true;
    logEventInServer('good verify app', {});
    callbackAfterValid();
}

function blockAppIfNotLegal() {
    if (!isLegal && legalValidation === true) {
        blockAppBecauseNotLegal();
    }

    return !isLegal && legalValidation === true;
}

function getLogEventUri() {
    return 'http://api.speaklabs.eu/api/app_event_logs';
}

function getDeviceUUId() {
    return device.uuid;
}

function getDeviceModel() {
    return device.model;
}

function getSystemVersion() {
    return device.version;
}

function logEventInServer(type, extraData) {
    var data = {
        deviceUUId: getDeviceUUId(),
        deviceModel: getDeviceModel(),
        deviceSystemVersion: getSystemVersion(),
        packageName: getPackageName(),
        type: type,
        extraData: JSON.stringify(extraData)
    };

    $.ajax({
        type: "POST",
        url: getLogEventUri(),
        contentType: "application/json",
        data: JSON.stringify(data)
    }).done(function (data) {
    }).fail(function (a, b, c) {
    });
}

function getDataAboutCurrentWordToLog() {
    var splitedWordSygn = getPathToActuWord().split('\\');
    return {
        day: dayJSON.day,
        category: splitedWordSygn[0],
        subcategory: splitedWordSygn[1],
        word: splitedWordSygn[2]
    };
}

function mergeObjects(obj1,obj2) {
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3;
}

function isOnlyNewLessonToEndDay(toLearn){
    for (var i = 0; i < (toLearn.length - 2); i++) {
        if (toLearn[i] > 0) {
            return false;
        }
        if(i == (toLearn.length - 3)) {
            return true;
        }
    }
}

function tellMeWordFrom(sygn, id, obj) {
    tellMeWord(sygn, id);

    var $item = $(obj);
    switch ($item.attr('data-source')) {
        case 'liked-word':
            logEventInServer('run sound in liked', {category: $item.attr('data-category'), subcategory: $item.attr('data-subcategory'), word: $item.attr('data-word')});
            break;
        case 'new-lesson':
            logEventInServer('run sound in new lesson start page', {category: $item.attr('data-category'), subcategory: $item.attr('data-subcategory'), word: $item.attr('data-word')});
            break;
        case 'all-words':
            logEventInServer('run sound in browsing phrases', {category: $item.attr('data-category'), subcategory: $item.attr('data-subcategory'), word: $item.attr('data-word')});
            break;
    }
}

function changeToDemo() {
    isPayedPro = false;
    $('body').removeClass('payed-version');
    $('body').addClass('unpayed-version');
    getAllCatsToShowAllCats();
    showMuteIcon();
}

function changeToPro() {
    isPayedPro = true;
    $('body').removeClass('unpayed-version');
    $('body').addClass('payed-version');
    getAllCatsToShowAllCats();
    showMuteIcon();
}

function canTellThisWord(catSygn, word) {
    return (
        isPremium == true || //wersja premium
        isPayedPro == true || //lub wersja demo opłacona
        catsWithAudioInDemo.indexOf(catSygn) >= 0 //lub są dostępne nagrania w wersji demo
    );
}

function initStore() {
    if (!window.store) {
        logEventInServer('error while shoping', {error: 'object window.store not found'});
        return;
    }

    store.error(function(error) {
        logEventInServer('error while shoping', {error: 'ERROR ' + error.code + ': ' + error.message});
    });

    store.register({
        id:    'premium.product', // id without package name!
        alias: 'premium.product',
        type:  store.NON_CONSUMABLE
    });

    store.when("premium.product").approved(function(p) {
        alert("approved premium.product");
        p.finish();
    });

    store.when("premium.product").updated(function(p) {
        if (p.owned) {
            alert('owned premium.product');
            // changeToPro();
            // if(buyPremiumWasClicked === true) {
            //     buyPremiumWasClicked = false;
            //     showThanksPageAfterBuying();
            // }
        } else {
            alert("no owned premium.product");
            // changeToDemo();
        }
    });

    store.register({
        id:    'subscription.premium', // id without package name!
        alias: 'subscription.premium',
        type:  store.PAID_SUBSCRIPTION
    });

    store.when("subscription.premium").approved(function(p) {
        p.verify();
    });

    store.when("subscription.premium").verified(function(p) {
        p.finish();
    });

    store.when("subscription.premium").updated(function(p) {
        if (p.owned) {
            changeToPro();
            if(buyPremiumWasClicked === true) {
                buyPremiumWasClicked = false;
                showThanksPageAfterBuying();
            }
        } else {
            changeToDemo();
        }
    });

    store.validator = function(product, callback) {
        alert("waliduje: " + product.title);
        var verifiData = product.transaction;
        verifiData.packageName = getPackageName();
        verifiData.receiptId = verifiData.id;
        delete verifiData.id;


        var url = getVerifiPurchaseApiUrl();
        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json",
            data: JSON.stringify(verifiData)
        }).done(function (data) {
            if(data === true) {
                callback(true, {}); // success!
            } else {
                callback(false, "Impossible to proceed with validation");
            }
        }).fail(function (a, b, c) {
            callback(false, "Impossible to proceed with validation");
        });
    };

    store.refresh();
}

var buyPremiumWasClicked = false;
function buyPremiumSubscription() {
    buyPremiumWasClicked = true;
    store.order('premium.product');
}

function showThanksPageAfterBuying() {
    navigator.notification.confirm(
        getTrans(t_thanks_for_buying_text),
        showThanksPageAfterBuyingCallback,
        getTrans(t_thanks_for_buying_title),
        getTrans(t_thanks_for_buying_ok)
    );
}

function showThanksPageAfterBuyingCallback() {

}

function showInfoPopupBeforeBuyingPremium(){
    navigator.notification.confirm(
        getTrans(t_before_buy_premium_text),
        showInfoPopupBeforeBuyingPremiumCallback,
        getTrans(t_before_buy_premium_title),
        getTrans(t_before_buy_premium_cancel) + "," + getTrans(t_before_buy_premium_buy)
    );
}

function showInfoPopupBeforeBuyingPremiumCallback(buttonIndex) {
    if (buttonIndex == 2) {
        buyPremiumSubscription();
    }
}